(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6509,8877],{6864:(e,t,a)=>{"use strict";a.d(t,{$H:()=>i,HW:()=>d,TK:()=>n,op:()=>c,wz:()=>r});var s=a(51070);let r=async e=>(await s.xh.get("/user/".concat(e))).data,n=async(e,t)=>(await s.xh.put("/user/".concat(e),t)).data,d=async()=>(await s.xh.get("/auth/me")).data,i=async(e,t)=>(await s.xh.put("/user/".concat(e,"/online-status"),{isOnline:t})).data,c=async e=>(await s.xh.get("/user/".concat(e,"/balance"))).data},16509:(e,t,a)=>{"use strict";a.d(t,{TJ:()=>i,_z:()=>c,createChat:()=>r,iS:()=>l,m7:()=>d,ug:()=>n});var s=a(51070);let r=async e=>s.xh.post("/chat/create",e),n=async()=>s.xh.get("/chat"),d=async e=>s.xh.get("/chat/delivery/".concat(e)),i=async e=>s.xh.get("/chat/".concat(e)),c=async(e,t)=>s.xh.post("/chat/".concat(e,"/messages"),t),l=async e=>s.xh.patch("/chat/".concat(e,"/messages/mark-read"))},39779:(e,t,a)=>{Promise.resolve().then(a.bind(a,70303))},50276:(e,t,a)=>{"use strict";a.d(t,{as:()=>s.ChatRoll,Ez:()=>n.LazyPickerFilters,Xg:()=>r.PickerCardMemo}),a(58343),a(97704);var s=a(74199);a(30478),a(21515);var r=a(54470);a(93183),a(98649),a(28331);var n=a(96701);a(81141),a(96033),a(19719)},70303:(e,t,a)=>{"use strict";a.d(t,{ChatPageClient:()=>v});var s=a(95155),r=a(12115),n=a(54581),d=a(14426),i=a(92302),c=a(71803),l=a(3127),o=a(71116),h=a(38464),u=a(60440),m=a(35695),x=a(43452),f=a(58343),p=a(50276),g=a(70541),y=a(18096),b=a(26564),j=a(16509);function k(e){let{senderChatId:t,receiverChatId:a,currentUserUid:d}=e,[i,o]=(0,r.useState)("sender"),[h,m]=(0,r.useState)(null),[x,k]=(0,r.useState)(null),[I,v]=(0,r.useState)([]),[w,C]=(0,r.useState)([]),[S,A]=(0,r.useState)(""),[N,P]=(0,r.useState)(!1),[D,z]=(0,r.useState)(0),[F,E]=(0,r.useState)(0),T=(0,r.useCallback)(async(e,t)=>{try{let a=(await (0,j.TJ)(e)).data;if(t){if(m(a),a.messages){let e=a.messages.map(e=>({id:e.id,senderId:e.senderId,senderName:e.senderName,content:e.content,timestamp:new Date(e.createdAt),isFromPicker:e.senderId===a.pickerId,chatSessionId:e.chatSessionId,attachments:e.attachments,read:e.read,createdAt:new Date(e.createdAt)}));v(e)}z(a.unreadCount||0)}else{if(k(a),a.messages){let e=a.messages.map(e=>({id:e.id,senderId:e.senderId,senderName:e.senderName,content:e.content,timestamp:new Date(e.createdAt),isFromPicker:e.senderId===a.pickerId,chatSessionId:e.chatSessionId,attachments:e.attachments,read:e.read,createdAt:new Date(e.createdAt)}));C(e)}E(a.unreadCount||0)}}catch(e){}},[]);(0,r.useEffect)(()=>{T(t,!0),a&&T(a,!1)},[t,a,T]),(0,r.useEffect)(()=>{(async()=>{try{"sender"===i?(await (0,j.iS)(t),z(0)):a&&(await (0,j.iS)(a),E(0))}catch(e){}})()},[i,t,a]);let _=(0,r.useCallback)(async()=>{if(!S.trim()||N)return;let e="sender"===i?t:a;if(!e)return;let s="sender"===i?h:x;if(s){P(!0);try{let t=(await (0,j._z)(e,{content:S.trim()})).data,a={id:t.id,senderId:t.senderId,senderName:t.senderName,content:t.content,timestamp:new Date(t.createdAt),isFromPicker:t.senderId===s.pickerId,chatSessionId:t.chatSessionId,attachments:t.attachments,read:t.read,createdAt:new Date(t.createdAt)};"sender"===i?v(e=>[...e,a]):C(e=>[...e,a]),A("")}catch(e){alert("Failed to send message. Please try again.")}finally{P(!1)}}},[S,N,i,t,a,h,x]),H="sender"===i?I:w,B="sender"===i?h:x,K=B?(B.pickerId,H.map(e=>({id:e.id,text:e.content,timestamp:e.timestamp,sender:{id:e.senderId,name:e.senderName,type:e.isFromPicker?"picker":"customer"},isOwn:e.senderId===d}))):[];return(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[(0,s.jsx)(n.default,{sx:{borderBottom:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(g.A,{value:i,onChange:(e,t)=>o(t),children:[(0,s.jsx)(y.A,{label:(0,s.jsx)(b.default,{badgeContent:D,color:"error",children:"Sender"}),value:"sender"}),a&&(0,s.jsx)(y.A,{label:(0,s.jsx)(b.default,{badgeContent:F,color:"error",children:"Receiver"}),value:"receiver"})]})}),(0,s.jsx)(n.default,{sx:{flex:1,overflow:"hidden",mx:2},children:(0,s.jsx)(p.as,{messages:K,height:"100%"})}),(0,s.jsx)(n.default,{sx:{p:2,borderTop:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(c.A,{direction:"row",spacing:1,alignItems:"flex-end",children:[(0,s.jsx)(f.ks,{value:S,onChange:e=>A(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())},placeholder:"Type your message...",disabled:N,multiline:!0,maxRows:3,size:"small",sx:{flex:1}}),(0,s.jsx)(l.A,{onClick:_,disabled:!S.trim()||N,sx:{bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"},"&:disabled":{bgcolor:"action.disabledBackground",color:"action.disabled"}},children:(0,s.jsx)(u.A,{fontSize:"small"})})]})})]})}var I=a(6864);function v(e){let{chatId:t}=e,a=(0,m.useRouter)(),[g,y]=(0,r.useState)(null),[b,v]=(0,r.useState)([]),[w,C]=(0,r.useState)(""),[S,A]=(0,r.useState)(!0),[N,P]=(0,r.useState)(""),[D,z]=(0,r.useState)(!1),[F,E]=(0,r.useState)(""),[T,_]=(0,r.useState)(""),[H,B]=(0,r.useState)(""),[K,R]=(0,r.useState)();(0,r.useEffect)(()=>{(async()=>{try{let e=await (0,I.HW)();E(e.user.uid),_(e.user.role)}catch(e){}})()},[]),(0,r.useEffect)(()=>{(async()=>{if(T){A(!0),P("");try{let e=(await (0,j.TJ)(t)).data;if(y(e),"picker"===T&&e.deliveryId){let t=(await (0,j.m7)(e.deliveryId)).data,a=t.find(e=>null!==e.senderId&&null===e.recipientId),s=t.find(e=>null!==e.recipientId);a&&B(a.id),s&&R(s.id)}if(e.messages&&"picker"!==T){let t=e.messages.map(t=>({id:t.id,senderId:t.senderId,senderName:t.senderName,content:t.content,timestamp:new Date(t.createdAt),isFromPicker:t.senderId===e.pickerId,chatSessionId:t.chatSessionId,attachments:t.attachments,read:t.read,createdAt:new Date(t.createdAt)}));v(t)}"picker"!==T&&await (0,j.iS)(t)}catch(e){P("Failed to load chat. Please try again.")}finally{A(!1)}}})()},[t,T]);let O=(0,r.useCallback)(async()=>{if(w.trim()&&!D){z(!0);try{let e=(await (0,j._z)(t,{content:w.trim()})).data,a={id:e.id,senderId:e.senderId,senderName:e.senderName,content:e.content,timestamp:new Date(e.createdAt),isFromPicker:e.senderId===(null==g?void 0:g.pickerId),chatSessionId:e.chatSessionId,attachments:e.attachments,read:e.read,createdAt:new Date(e.createdAt)};v(e=>[...e,a]),C("")}catch(e){alert("Failed to send message. Please try again.")}finally{z(!1)}}},[w,D,t,g]),W=b.map(e=>({id:e.id,text:e.content,timestamp:e.timestamp,sender:{id:e.senderId,name:e.senderName,type:e.isFromPicker?"picker":"customer"},isOwn:e.senderId===F}));return S?(0,s.jsx)(n.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:(0,s.jsx)(d.default,{})}):N?(0,s.jsx)(n.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",p:2},children:(0,s.jsx)(i.A,{severity:"error",children:N})}):g?"picker"===T&&(null==g?void 0:g.deliveryId)&&H?(0,s.jsx)(n.default,{sx:{minHeight:"100vh",bgcolor:"background.default",display:"flex",alignItems:"center",justifyContent:"center",p:2},children:(0,s.jsx)(x.MobileContainer,{showFrame:!1,children:(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[(0,s.jsx)(n.default,{sx:{p:2,borderBottom:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(c.A,{direction:"row",alignItems:"center",spacing:2,children:[(0,s.jsx)(l.A,{onClick:()=>a.push("/chats"),size:"small",sx:{p:1},children:(0,s.jsx)(h.A,{})}),(0,s.jsx)(n.default,{sx:{flex:1},children:(0,s.jsx)(o.default,{variant:"h6",sx:{fontWeight:"bold"},children:"Delivery Chat"})}),(0,s.jsx)(f.Lm,{variant:"icon",size:"small"})]})}),(0,s.jsx)(k,{senderChatId:H,receiverChatId:K,currentUserUid:F})]})})}):(0,s.jsx)(n.default,{sx:{minHeight:"100vh",bgcolor:"background.default",display:"flex",alignItems:"center",justifyContent:"center",p:2},children:(0,s.jsx)(x.MobileContainer,{showFrame:!1,children:(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[(0,s.jsx)(n.default,{sx:{p:2,borderBottom:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(c.A,{direction:"row",alignItems:"center",spacing:2,children:[(0,s.jsx)(l.A,{onClick:()=>a.push("/chats"),size:"small",sx:{p:1},children:(0,s.jsx)(h.A,{})}),(0,s.jsx)(n.default,{sx:{flex:1},children:(0,s.jsx)(o.default,{variant:"h6",sx:{fontWeight:"bold"},children:g&&F?F===g.senderId?g.pickerName||"Picker":g.senderName||"Sender":"Chat"})}),(0,s.jsx)(f.Lm,{variant:"icon",size:"small"})]})}),(0,s.jsx)(n.default,{sx:{flex:1,overflow:"hidden",mx:2},children:(0,s.jsx)(p.as,{messages:W,height:"100%"})}),(0,s.jsx)(n.default,{sx:{p:2,borderTop:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(c.A,{direction:"row",spacing:1,alignItems:"flex-end",children:[(0,s.jsx)(f.ks,{value:w,onChange:e=>C(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),O())},placeholder:"Type your message...",disabled:D,multiline:!0,maxRows:3,size:"small",sx:{flex:1}}),(0,s.jsx)(l.A,{onClick:O,disabled:!w.trim()||D,sx:{bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"},"&:disabled":{bgcolor:"action.disabledBackground",color:"action.disabled"}},children:(0,s.jsx)(u.A,{fontSize:"small"})})]})})]})})}):(0,s.jsx)(n.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",p:2},children:(0,s.jsx)(i.A,{severity:"warning",children:"Chat not found"})})}}},e=>{e.O(0,[6084,3965,7225,3964,8202,6592,8534,7844,1101,5207,8652,8449,1190,7615,1986,2649,7212,1530,816,8152,8343,4597,8441,5964,7358],()=>e(e.s=39779)),_N_E=e.O()}]);