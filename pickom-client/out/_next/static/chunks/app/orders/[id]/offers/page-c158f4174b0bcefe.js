(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1294],{22470:(e,t,r)=>{"use strict";r.d(t,{default:()=>W});var a=r(95155),i=r(12115),n=r(54581),l=r(71116),o=r(3127),c=r(70541),s=r(18096),d=r(14426),u=r(92302),f=r(36114),p=r(54492),h=r(99927),x=r(76871),y=r(71977),j=r(68534),m=r(38464),b=r(57773),v=r(35695),g=r(43452),A=r(97704),k=r(47075),w=r(78780),C=r(21787),I=r(6864),S=r(16509),N=r(28069),P=r(87358);function W(e){let{params:t}=e,r=(0,i.use)(t),W=(0,v.useRouter)(),T=Number(r.id),[R,F]=(0,i.useState)([]),[O,_]=(0,i.useState)(0),[q,M]=(0,i.useState)(!0),[B,D]=(0,i.useState)(""),[E,U]=(0,i.useState)("all"),[L,z]=(0,i.useState)(0),[V,Y]=(0,i.useState)(""),[$,H]=(0,i.useState)({open:!1,type:null,offerId:null}),[X,G]=(0,i.useState)({open:!1,required:0,current:0}),[J,Z]=(0,i.useState)(!1);(0,i.useEffect)(()=>{(async()=>{M(!0),D("");try{let e=(await (0,N.Nq)()).data.user;Y(e.uid);let t=await (0,I.op)(e.uid);z(Number(t.balance)||0);let r=await (0,C.IT)(T);_(r.data.price);let a=(await (0,w.F8)(T)).data,i=await Promise.all(a.map(async e=>{try{let t=(await (0,I.wz)(e.pickerId)).user,r={uid:t.uid,fullName:t.name,avatarUrl:t.avatarUrl,rating:4.5,reviewCount:42,completedDeliveries:100,vehicle:"Car",isVerified:!0,isPhoneVerified:!!t.phone,isEmailVerified:!0,trustLevel:85};return{...e,picker:r}}catch(t){return e}}));F(i)}catch(e){D("Failed to load offers. Please try again.")}finally{M(!1)}})()},[T]);let K=(0,i.useMemo)(()=>"all"===E?R:R.filter(e=>e.status===E),[R,E]),Q=async e=>{try{let{chatId:t}=(await (0,S.createChat)({participantId:e,deliveryId:T})).data;W.push("/chat/".concat(t))}catch(e){alert("Failed to open chat. Please try again.")}},ee=async e=>{let t=R.find(t=>t.id===e);if(!t)return void alert("Offer not found");try{let r=await (0,I.op)(V),a=Number(r.balance)||0;if(z(a),a<t.price)return void G({open:!0,required:t.price,current:a});H({open:!0,type:"accept",offerId:e})}catch(e){alert("Failed to verify balance. Please try again.")}},et=async()=>{if($.offerId){Z(!0);try{let e="accept"===$.type?"accepted":"rejected",t=R.find(e=>e.id===$.offerId);if(!t)return void alert("Offer not found");if("accept"===$.type){let r=P.env.NEXT_PUBLIC_API_URL||"https://pickom.qirelab.com";try{await fetch("".concat(r,"/payment/pay-with-balance"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({amount:Number(t.price),deliveryId:T,description:"Payment for delivery #".concat(T),toUserId:t.pickerId})})}catch(e){console.error("Balance payment failed:",e),alert("Payment failed: ".concat(e.message||"Unknown error")),Z(!1);return}await (0,w.i6)($.offerId,{status:e,paymentMethod:"balance"}),await (0,C.updateDeliveryRequest)(T,{pickerId:t.pickerId,status:"accepted"});let a=R.filter(e=>e.id!==$.offerId&&"pending"===e.status);await Promise.all(a.map(e=>(0,w.i6)(e.id,{status:"rejected"}))),alert("Offer accepted! The picker has been assigned and other offers have been rejected."),W.push("/orders/".concat(T))}else await (0,w.i6)($.offerId,{status:e}),F(e=>e.map(e=>e.id===$.offerId?{...e,status:"rejected"}:e)),alert("Offer rejected. The picker has been notified.")}catch(e){alert("Failed to update offer. Please try again.")}finally{Z(!1),H({open:!1,type:null,offerId:null})}}},er=()=>{H({open:!1,type:null,offerId:null})},ea=(0,i.useMemo)(()=>({all:R.length,pending:R.filter(e=>"pending"===e.status).length,accepted:R.filter(e=>"accepted"===e.status).length,rejected:R.filter(e=>"rejected"===e.status).length}),[R]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(g.MobileContainer,{showFrame:!1,children:(0,a.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"background.default"},children:[(0,a.jsxs)(n.default,{sx:{display:"flex",alignItems:"center",gap:1,p:2,borderBottom:1,borderColor:"divider"},children:[(0,a.jsx)(o.A,{onClick:()=>{W.push("/orders/".concat(T))},size:"small",children:(0,a.jsx)(m.A,{})}),(0,a.jsx)(b.A,{sx:{color:"primary.main"}}),(0,a.jsxs)(l.default,{variant:"h6",sx:{fontWeight:600,flex:1},children:["Delivery #",T," - Offers"]})]}),(0,a.jsxs)(c.A,{value:E,onChange:(e,t)=>{U(t)},variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:48,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem",fontWeight:500,textTransform:"none"}},children:[(0,a.jsx)(s.A,{label:"All (".concat(ea.all,")"),value:"all"}),(0,a.jsx)(s.A,{label:"Pending (".concat(ea.pending,")"),value:"pending"}),(0,a.jsx)(s.A,{label:"Accepted (".concat(ea.accepted,")"),value:"accepted"}),(0,a.jsx)(s.A,{label:"Rejected (".concat(ea.rejected,")"),value:"rejected"})]}),(0,a.jsx)(n.default,{sx:{flex:1,overflow:"auto",pb:8},children:q?(0,a.jsx)(n.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:8},children:(0,a.jsx)(d.default,{})}):B?(0,a.jsx)(n.default,{sx:{p:3},children:(0,a.jsx)(u.A,{severity:"error",children:B})}):0===K.length?(()=>{let e={all:{icon:"\uD83D\uDCED",title:"No offers yet",description:"Pickers will see your delivery and can make offers."},pending:{icon:"⏳",title:"No pending offers",description:"All offers have been reviewed."},accepted:{icon:"✅",title:"No accepted offers",description:"Accepted offers will appear here."},rejected:{icon:"❌",title:"No rejected offers",description:"Rejected offers will appear here."}}[E];return(0,a.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:8,px:3},children:[(0,a.jsx)(l.default,{sx:{fontSize:"4rem",mb:2},children:e.icon}),(0,a.jsx)(l.default,{variant:"h6",sx:{fontWeight:600,mb:1,textAlign:"center"},children:e.title}),(0,a.jsx)(l.default,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:e.description})]})})():(0,a.jsx)(n.default,{sx:{p:2},children:K.map(e=>e.picker?(0,a.jsx)(k.A,{offer:e,picker:e.picker,originalPrice:O,onChat:()=>Q(e.pickerId),onAccept:()=>ee(e.id),onReject:()=>{H({open:!0,type:"reject",offerId:e.id})},disabled:J},e.id):(0,a.jsx)(n.default,{sx:{p:2,mb:2},children:(0,a.jsxs)(u.A,{severity:"warning",children:["Unable to load picker data for offer #",e.id]})},e.id))})})]})}),(0,a.jsx)(A.default,{}),(0,a.jsxs)(f.A,{open:$.open,onClose:er,maxWidth:"xs",fullWidth:!0,children:[(0,a.jsx)(p.A,{children:"accept"===$.type?"Accept Offer?":"Reject Offer?"}),(0,a.jsx)(h.A,{children:(0,a.jsx)(x.A,{children:"accept"===$.type?(0,a.jsx)(a.Fragment,{children:"You are about to accept this offer. The picker will be assigned to your delivery and all other pending offers will be automatically rejected."}):(0,a.jsx)(a.Fragment,{children:"You are about to reject this offer. The picker will be notified. This action cannot be undone."})})}),(0,a.jsxs)(y.A,{sx:{px:3,py:2},children:[(0,a.jsx)(j.A,{onClick:er,variant:"outlined",disabled:J,children:"Cancel"}),(0,a.jsx)(j.A,{onClick:et,variant:"contained",color:"accept"===$.type?"success":"error",disabled:J,children:J?"Processing...":"accept"===$.type?"Accept":"Reject"})]})]}),(0,a.jsxs)(f.A,{open:X.open,onClose:()=>G({open:!1,required:0,current:0}),maxWidth:"xs",fullWidth:!0,children:[(0,a.jsx)(p.A,{sx:{color:"error.main"},children:"Insufficient Balance"}),(0,a.jsxs)(h.A,{children:[(0,a.jsx)(x.A,{sx:{mb:2},children:"You don't have enough balance to accept this offer. Please top up your account to continue."}),(0,a.jsxs)(n.default,{sx:{backgroundColor:"grey.100",p:2,borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[(0,a.jsxs)(n.default,{sx:{display:"flex",justifyContent:"space-between"},children:[(0,a.jsx)(l.default,{variant:"body2",color:"text.secondary",children:"Current Balance:"}),(0,a.jsxs)(l.default,{variant:"body2",fontWeight:600,children:["$",X.current.toFixed(2)]})]}),(0,a.jsxs)(n.default,{sx:{display:"flex",justifyContent:"space-between"},children:[(0,a.jsx)(l.default,{variant:"body2",color:"text.secondary",children:"Required Amount:"}),(0,a.jsxs)(l.default,{variant:"body2",fontWeight:600,color:"error",children:["$",X.required.toFixed(2)]})]}),(0,a.jsxs)(n.default,{sx:{display:"flex",justifyContent:"space-between",pt:1,borderTop:1,borderColor:"divider"},children:[(0,a.jsx)(l.default,{variant:"body2",color:"text.secondary",children:"Need to Add:"}),(0,a.jsxs)(l.default,{variant:"body1",fontWeight:700,color:"primary",children:["$",(X.required-X.current).toFixed(2)]})]})]})]}),(0,a.jsxs)(y.A,{sx:{px:3,py:2},children:[(0,a.jsx)(j.A,{onClick:()=>G({open:!1,required:0,current:0}),variant:"outlined",children:"Cancel"}),(0,a.jsx)(j.A,{onClick:()=>W.push("/earnings/top-up"),variant:"contained",color:"primary",children:"Top Up Balance"})]})]})]})}},41074:(e,t,r)=>{Promise.resolve().then(r.bind(r,22470))},57316:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(11772).Ay)()},71803:(e,t,r)=>{"use strict";r.d(t,{A:()=>g});var a=r(12115),i=r(52596),n=r(72890),l=r(90870),o=r(17472),c=r(57316),s=r(25560),d=r(5300),u=r(85799),f=r(648),p=r(83130),h=r(95155);let x=(0,u.A)(),y=(0,c.A)("div",{name:"MuiStack",slot:"Root"});function j(e){return(0,s.A)({props:e,name:"MuiStack",defaultTheme:x})}let m=e=>{let{ownerState:t,theme:r}=e,a={display:"flex",flexDirection:"column",...(0,f.NI)({theme:r},(0,f.kW)({values:t.direction,breakpoints:r.breakpoints.values}),e=>({flexDirection:e}))};if(t.spacing){let e=(0,p.LX)(r),i=Object.keys(r.breakpoints.values).reduce((e,r)=>(("object"==typeof t.spacing&&null!=t.spacing[r]||"object"==typeof t.direction&&null!=t.direction[r])&&(e[r]=!0),e),{}),l=(0,f.kW)({values:t.direction,base:i}),o=(0,f.kW)({values:t.spacing,base:i});"object"==typeof l&&Object.keys(l).forEach((e,t,r)=>{if(!l[e]){let a=t>0?l[r[t-1]]:"column";l[e]=a}}),a=(0,n.A)(a,(0,f.NI)({theme:r},o,(r,a)=>t.useFlexGap?{gap:(0,p._W)(e,r)}:{"& > :not(style):not(style)":{margin:0},"& > :not(style) ~ :not(style)":{["margin".concat({row:"Left","row-reverse":"Right",column:"Top","column-reverse":"Bottom"}[a?l[a]:t.direction])]:(0,p._W)(e,r)}}))}return(0,f.iZ)(r.breakpoints,a)};var b=r(75955),v=r(10186);let g=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{createStyledComponent:t=y,useThemeProps:r=j,componentName:n="MuiStack"}=e,c=t(m);return a.forwardRef(function(e,t){let s=r(e),{component:u="div",direction:f="column",spacing:p=0,divider:x,children:y,className:j,useFlexGap:m=!1,...b}=(0,d.A)(s),v=(0,o.A)({root:["root"]},e=>(0,l.Ay)(n,e),{});return(0,h.jsx)(c,{as:u,ownerState:{direction:f,spacing:p,useFlexGap:m},ref:t,className:(0,i.A)(v.root,j),...b,children:x?function(e,t){let r=a.Children.toArray(e).filter(Boolean);return r.reduce((e,i,n)=>(e.push(i),n<r.length-1&&e.push(a.cloneElement(t,{key:"separator-".concat(n)})),e),[])}(y,x):y})})}({createStyledComponent:(0,b.Ay)("div",{name:"MuiStack",slot:"Root"}),useThemeProps:e=>(0,v.b)({props:e,name:"MuiStack"})})}},e=>{e.O(0,[3965,7225,3964,8202,6592,8534,7844,1101,5207,8652,1190,7615,9853,5409,8441,5964,7358],()=>e(e.s=41074)),_N_E=e.O()}]);