(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2192],{4320:(e,t,a)=>{Promise.resolve().then(a.bind(a,63252))},19505:(e,t,a)=>{"use strict";a.d(t,{A:()=>i});var r=a(31418),n=a(95155);let i=(0,r.A)((0,n.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete")},22122:(e,t,a)=>{"use strict";a.d(t,{A:()=>i});var r=a(31418),n=a(95155);let i=(0,r.A)((0,n.jsx)("path",{d:"M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2zm-9-2h10V8H12zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5"}),"AccountBalanceWallet")},38637:(e,t,a)=>{e.exports=a(79399)()},40857:(e,t,a)=>{"use strict";a.d(t,{A:()=>i});var r=a(31418),n=a(95155);let i=(0,r.A)((0,n.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add")},63252:(e,t,a)=>{"use strict";a.d(t,{default:()=>F});var r=a(95155),n=a(12115),i=a(54581),l=a(71116),c=a(3127),s=a(70541),o=a(18096),d=a(14426),f=a(92302),p=a(36114),u=a(54492),h=a(99927),y=a(76871),x=a(71977),m=a(68534),j=a(74964),v=a(38464),b=a(57773),g=a(22122),A=a(72093),I=a(40857),P=a(35695),C=a(43452),k=a(97704),w=a(47075),S=a(78780),T=a(21787),O=a(6864),N=a(16509),_=a(28069),W=a(77560),M=a(23464),R=a(87358);function F(e){let{params:t}=e,a=(0,n.use)(t),F=(0,P.useRouter)(),z=Number(a.id),[E,H]=(0,n.useState)([]),[D,V]=(0,n.useState)(0),[U,B]=(0,n.useState)(!0),[L,q]=(0,n.useState)(""),[Y,$]=(0,n.useState)("all"),[X,G]=(0,n.useState)(0),[J,K]=(0,n.useState)(""),[Q,Z]=(0,n.useState)({open:!1,type:null,offerId:null}),[ee,et]=(0,n.useState)({open:!1,offerId:null,offerPrice:0}),[ea,er]=(0,n.useState)({type:null}),[en,ei]=(0,n.useState)(!1),[el,ec]=(0,n.useState)(!1);(0,n.useEffect)(()=>{(async()=>{B(!0),q("");try{let e=(await (0,_.Nq)()).data.user;K(e.uid);let t=await (0,O.op)(e.uid);G(Number(t.balance)||0);let a=await (0,T.IT)(z);V(a.data.price);let r=(await (0,S.F8)(z)).data,n=await Promise.all(r.map(async e=>{try{let t=(await (0,O.wz)(e.pickerId)).user,a={uid:t.uid,fullName:t.name,avatarUrl:t.avatarUrl,rating:4.5,reviewCount:42,completedDeliveries:100,vehicle:"Car",isVerified:!0,isPhoneVerified:!!t.phone,isEmailVerified:!0,trustLevel:85};return{...e,picker:a}}catch(t){return e}}));H(n)}catch(e){q("Failed to load offers. Please try again.")}finally{B(!1)}})()},[z]);let es=(0,n.useMemo)(()=>"all"===Y?E:E.filter(e=>e.status===Y),[E,Y]),eo=async e=>{try{let{chatId:t}=(await (0,N.createChat)({participantId:e,deliveryId:z})).data;F.push("/chat/".concat(t))}catch(e){alert("Failed to open chat. Please try again.")}},ed=async e=>{let t=E.find(t=>t.id===e);if(!t)return void alert("Offer not found");try{let a=await (0,O.op)(J),r=Number(a.balance)||0;G(r),et({open:!0,offerId:e,offerPrice:Number(t.price)})}catch(e){alert("Failed to verify balance. Please try again.")}},ef=async()=>{if(!ee.offerId)return;let e=Number(ee.offerPrice||0);if(X<e)return void alert("Insufficient balance. You need $".concat((e-X).toFixed(2)," more. Please top up your balance first."));er({type:"balance"}),et({open:!1,offerId:null,offerPrice:0}),Z({open:!0,type:"accept",offerId:ee.offerId})},ep=async()=>{if(Q.offerId){ec(!0);try{let n="accept"===Q.type?"accepted":"rejected",i=E.find(e=>e.id===Q.offerId);if(!i)return void alert("Offer not found");if("accept"===Q.type){var e,t,a,r;let l,c=R.env.NEXT_PUBLIC_API_URL||"https://pickom.qirelab.com";if("card"===ea.type&&ea.cardId)try{l=(await M.A.post("".concat(c,"/payment/create-intent"),{amount:Number(i.price),deliveryId:z,description:"Payment for delivery #".concat(z),paymentMethodId:ea.cardId,toUserId:i.pickerId},{withCredentials:!0})).data.paymentIntentId}catch(r){console.error("Payment failed:",r);let a=(null==(t=r.response)||null==(e=t.data)?void 0:e.message)||r.message||"Payment failed";alert("Payment failed: ".concat(a)),ec(!1);return}else if("balance"===ea.type)try{await M.A.post("".concat(c,"/payment/pay-with-balance"),{amount:Number(i.price),deliveryId:z,description:"Payment for delivery #".concat(z),toUserId:i.pickerId},{withCredentials:!0})}catch(t){console.error("Balance payment failed:",t);let e=(null==(r=t.response)||null==(a=r.data)?void 0:a.message)||t.message||"Payment failed";alert("Payment failed: ".concat(e)),ec(!1);return}await (0,S.i6)(Q.offerId,{status:n,paymentMethod:ea.type||void 0,paymentIntentId:l}),await (0,T.updateDeliveryRequest)(z,{pickerId:i.pickerId,status:"accepted"});let s=E.filter(e=>e.id!==Q.offerId&&"pending"===e.status);await Promise.all(s.map(e=>(0,S.i6)(e.id,{status:"rejected"}))),alert("Offer accepted! Payment processed and picker assigned."),F.push("/delivery-methods?tab=manage")}else await (0,S.i6)(Q.offerId,{status:n}),H(e=>e.map(e=>e.id===Q.offerId?{...e,status:"rejected"}:e)),alert("Offer rejected. The picker has been notified.")}catch(e){alert("Failed to update offer. Please try again.")}finally{ec(!1),Z({open:!1,type:null,offerId:null})}}},eu=()=>{Z({open:!1,type:null,offerId:null})},eh=(0,n.useMemo)(()=>({all:E.length,pending:E.filter(e=>"pending"===e.status).length,accepted:E.filter(e=>"accepted"===e.status).length,rejected:E.filter(e=>"rejected"===e.status).length}),[E]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(C.MobileContainer,{showFrame:!1,children:(0,r.jsxs)(i.default,{sx:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"background.default"},children:[(0,r.jsxs)(i.default,{sx:{display:"flex",alignItems:"center",gap:1,p:2,borderBottom:1,borderColor:"divider"},children:[(0,r.jsx)(c.A,{onClick:()=>{F.push("/delivery-methods?tab=manage")},size:"small",children:(0,r.jsx)(v.A,{})}),(0,r.jsx)(b.A,{sx:{color:"primary.main"}}),(0,r.jsxs)(l.default,{variant:"h6",sx:{fontWeight:600,flex:1},children:["Delivery #",z," - Offers"]})]}),(0,r.jsxs)(s.A,{value:Y,onChange:(e,t)=>{$(t)},variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:48,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem",fontWeight:500,textTransform:"none"}},children:[(0,r.jsx)(o.A,{label:"All (".concat(eh.all,")"),value:"all"}),(0,r.jsx)(o.A,{label:"Pending (".concat(eh.pending,")"),value:"pending"}),(0,r.jsx)(o.A,{label:"Accepted (".concat(eh.accepted,")"),value:"accepted"}),(0,r.jsx)(o.A,{label:"Rejected (".concat(eh.rejected,")"),value:"rejected"})]}),(0,r.jsx)(i.default,{sx:{flex:1,overflow:"auto",pb:8},children:U?(0,r.jsx)(i.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:8},children:(0,r.jsx)(d.default,{})}):L?(0,r.jsx)(i.default,{sx:{p:3},children:(0,r.jsx)(f.A,{severity:"error",children:L})}):0===es.length?(()=>{let e={all:{icon:"\uD83D\uDCED",title:"No offers yet",description:"Pickers will see your delivery and can make offers."},pending:{icon:"⏳",title:"No pending offers",description:"All offers have been reviewed."},accepted:{icon:"✅",title:"No accepted offers",description:"Accepted offers will appear here."},rejected:{icon:"❌",title:"No rejected offers",description:"Rejected offers will appear here."}}[Y];return(0,r.jsxs)(i.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:8,px:3},children:[(0,r.jsx)(l.default,{sx:{fontSize:"4rem",mb:2},children:e.icon}),(0,r.jsx)(l.default,{variant:"h6",sx:{fontWeight:600,mb:1,textAlign:"center"},children:e.title}),(0,r.jsx)(l.default,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:e.description})]})})():(0,r.jsx)(i.default,{sx:{p:2},children:es.map(e=>e.picker?(0,r.jsx)(w.A,{offer:{id:e.id,pickerId:e.pickerId,price:e.price,message:e.message,status:e.status,createdAt:e.createdAt instanceof Date?e.createdAt.toISOString():e.createdAt},picker:e.picker,originalPrice:D,onChat:()=>eo(e.pickerId),onAccept:()=>ed(e.id),onReject:()=>{Z({open:!0,type:"reject",offerId:e.id})},disabled:el},e.id):(0,r.jsx)(i.default,{sx:{p:2,mb:2},children:(0,r.jsxs)(f.A,{severity:"warning",children:["Unable to load picker data for offer #",e.id]})},e.id))})})]})}),(0,r.jsx)(k.default,{}),(0,r.jsxs)(p.A,{open:Q.open,onClose:eu,maxWidth:"xs",fullWidth:!0,children:[(0,r.jsx)(u.A,{children:"accept"===Q.type?"Accept Offer?":"Reject Offer?"}),(0,r.jsx)(h.A,{children:(0,r.jsx)(y.A,{children:"accept"===Q.type?(0,r.jsx)(r.Fragment,{children:"You are about to accept this offer. The picker will be assigned to your delivery and all other pending offers will be automatically rejected."}):(0,r.jsx)(r.Fragment,{children:"You are about to reject this offer. The picker will be notified. This action cannot be undone."})})}),(0,r.jsxs)(x.A,{sx:{px:3,py:2},children:[(0,r.jsx)(m.A,{onClick:eu,variant:"outlined",disabled:el,children:"Cancel"}),(0,r.jsx)(m.A,{onClick:ep,variant:"contained",color:"accept"===Q.type?"success":"error",disabled:el,children:el?"Processing...":"accept"===Q.type?"Accept":"Reject"})]})]}),(0,r.jsxs)(p.A,{open:ee.open,onClose:()=>et({open:!1,offerId:null,offerPrice:0}),maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[(0,r.jsx)(u.A,{children:"Select Payment Method"}),(0,r.jsx)(h.A,{children:(0,r.jsxs)(i.default,{sx:{pt:1},children:[(0,r.jsxs)(l.default,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Choose how you want to pay $",ee.offerPrice.toFixed(2)," for this delivery"]}),(0,r.jsxs)(i.default,{sx:{display:"flex",flexDirection:"column",gap:2},children:[(0,r.jsx)(m.A,{variant:"outlined",startIcon:(0,r.jsx)(g.A,{}),onClick:ef,fullWidth:!0,sx:{py:1.5,justifyContent:"flex-start",textTransform:"none"},children:(0,r.jsxs)(i.default,{sx:{flex:1,textAlign:"left"},children:[(0,r.jsx)(l.default,{variant:"body1",children:"Pay with Balance"}),(0,r.jsxs)(l.default,{variant:"caption",color:"text.secondary",children:["Current balance: $",X.toFixed(2)]})]})}),(0,r.jsx)(m.A,{variant:"outlined",startIcon:(0,r.jsx)(A.default,{}),onClick:()=>ei(!0),fullWidth:!0,sx:{py:1.5,justifyContent:"flex-start",textTransform:"none"},children:"Pay with Saved Card"}),(0,r.jsx)(m.A,{variant:"text",startIcon:(0,r.jsx)(I.A,{}),onClick:()=>F.push("/payment-methods"),fullWidth:!0,sx:{py:1,justifyContent:"flex-start",textTransform:"none"},children:"Manage Payment Methods"})]}),(0,r.jsx)(j.A,{sx:{my:2}}),(0,r.jsx)(l.default,{variant:"caption",color:"text.secondary",children:"All payments are securely processed"})]})}),(0,r.jsx)(x.A,{children:(0,r.jsx)(m.A,{onClick:()=>et({open:!1,offerId:null,offerPrice:0}),color:"inherit",children:"Cancel"})})]}),(0,r.jsx)(W.A,{open:en,onClose:()=>ei(!1),onCardSelected:e=>{ee.offerId&&(er({type:"card",cardId:e}),ei(!1),et({open:!1,offerId:null,offerPrice:0}),Z({open:!0,type:"accept",offerId:ee.offerId}))},title:"Select Card for Payment"})]})}},72093:(e,t,a)=>{"use strict";a.d(t,{default:()=>i});var r=a(31418),n=a(95155);let i=(0,r.A)((0,n.jsx)("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"CreditCard")},72948:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},79399:(e,t,a)=>{"use strict";var r=a(72948);function n(){}function i(){}i.resetWarningCache=n,e.exports=function(){function e(e,t,a,n,i,l){if(l!==r){var c=Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw c.name="Invariant Violation",c}}function t(){return e}e.isRequired=e;var a={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:i,resetWarningCache:n};return a.PropTypes=a,a}}},e=>{e.O(0,[3965,7225,3964,8202,6592,8534,7844,1101,5207,8652,1190,7615,1530,507,9853,5409,7560,8441,5964,7358],()=>e(e.s=4320)),_N_E=e.O()}]);