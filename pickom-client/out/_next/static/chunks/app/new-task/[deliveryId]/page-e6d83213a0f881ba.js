(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6159],{6864:(e,t,r)=>{"use strict";r.d(t,{$H:()=>o,HW:()=>l,TK:()=>c,op:()=>s,wz:()=>n});var a=r(51070);let n=async e=>(await a.xh.get("/user/".concat(e))).data,c=async(e,t)=>(await a.xh.put("/user/".concat(e),t)).data,l=async()=>(await a.xh.get("/auth/me")).data,o=async(e,t)=>(await a.xh.put("/user/".concat(e,"/online-status"),{isOnline:t})).data,s=async e=>(await a.xh.get("/user/".concat(e,"/balance"))).data},14140:(e,t,r)=>{"use strict";r.d(t,{j:()=>l});var a=r(23915),n=r(45404);let c=(0,a.Wp)({apiKey:"AIzaSyDiclg8XNo2L1hDBoaSoHmFMBggUKYjHH4",authDomain:"pickom-mvp.firebaseapp.com",projectId:"pickom-mvp",storageBucket:"pickom-mvp.firebasestorage.app",messagingSenderId:"168767828055",appId:"1:168767828055:web:2853961b44970c114ab312"}),l=(0,n.xI)(c)},21787:(e,t,r)=>{"use strict";r.d(t,{IT:()=>o,S1:()=>d,TS:()=>g,XE:()=>s,confirmRecipient:()=>h,createDeliveryRequest:()=>c,qM:()=>u,rg:()=>p,updateDeliveryRequest:()=>i,vd:()=>n,zW:()=>l});var a=r(51070);let n=async()=>a.Bb.get("/delivery/pickers"),c=async e=>a.xh.post("/delivery/requests",e),l=async()=>a.xh.get("/delivery/requests"),o=async e=>a.xh.get("/delivery/requests/".concat(e)),s=async(e,t)=>a.xh.put("/delivery/requests/".concat(e,"/status"),{status:t}),i=async(e,t)=>a.xh.patch("/delivery/requests/".concat(e),t),u=async()=>a.xh.get("/delivery/completed"),d=async()=>a.xh.get("/delivery/cancelled"),h=async(e,t)=>a.xh.put("/delivery/requests/".concat(e,"/confirm-recipient"),{confirmed:t}),p=async e=>a.xh.post("/delivery/find-receiver",{email:e}),g=async()=>a.xh.get("/delivery/incoming")},28069:(e,t,r)=>{"use strict";r.d(t,{Nq:()=>s,c4:()=>c,mH:()=>o,mg:()=>l,vx:()=>i});var a=r(51070),n=r(14140);let c=async()=>{let e=n.j.currentUser;return e?await e.getIdToken():null},l=async e=>a.Bb.post("/auth/login",{},{headers:{Authorization:"Bearer ".concat(e)}}),o=async(e,t,r,n)=>a.Bb.post("/auth/register",{role:e,phone:r,name:n},{headers:{Authorization:"Bearer ".concat(t)}}),s=async()=>a.xh.get("/auth/me"),i=async()=>a.xh.post("/auth/logout")},51070:(e,t,r)=>{"use strict";r.d(t,{Bb:()=>o,H$:()=>c,xh:()=>l,y3:()=>s});var a=r(23464),n=r(14140);let c=r(6267).Ii.isNativePlatform()?"http://10.0.2.2:4242":"http://localhost:4242",l=a.A.create({baseURL:c,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});l.interceptors.request.use(async e=>{let t=n.j.currentUser;if(t)try{let r=await t.getIdToken();e.headers.Authorization="Bearer ".concat(r)}catch(e){}return e},e=>Promise.reject(e)),l.interceptors.response.use(e=>e,e=>Promise.reject(e));let o=a.A.create({baseURL:c,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});async function s(){try{return await a.A.get("".concat(c,"/api"),{timeout:5e3}),!0}catch(e){return!1}}o.interceptors.response.use(e=>e,e=>Promise.reject(e))},67780:(e,t,r)=>{"use strict";r.d(t,{default:()=>W});var a=r(95155),n=r(12115),c=r(35695),l=r(55028),o=r(54581),s=r(14426),i=r(92302),u=r(18407),d=r(71116),h=r(41101),p=r(42663),g=r(32110),x=r(40272),f=r(11414),v=r(335),y=r(60807),m=r(68558),j=r(21787),b=r(6864),k=r(14298),w=r(28069);let A=r(87358).env.NEXT_PUBLIC_SERVER||"http://localhost:3000",I=e=>{let{deliveryId:t,userId:r,enabled:a,onLocationUpdate:c,onStatusUpdate:l,onTrackingData:o,onError:s}=e,i=(0,n.useRef)(null),[u,d]=(0,n.useState)(!1),[h,p]=(0,n.useState)(null),g=(0,n.useRef)(c),x=(0,n.useRef)(l),f=(0,n.useRef)(o),v=(0,n.useRef)(s);return(0,n.useEffect)(()=>{g.current=c,x.current=l,f.current=o,v.current=s},[c,l,o,s]),(0,n.useEffect)(()=>{if(a)return(async()=>{var e,a;try{let a=await (0,w.c4)();if(!a){null==(e=v.current)||e.call(v,"Authentication token not found");return}let n=(0,k.io)("".concat(A,"/tracking"),{transportOptions:{polling:{extraHeaders:{Authorization:"Bearer ".concat(a)}}},extraHeaders:{Authorization:"Bearer ".concat(a)},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});n.on("connect",()=>{console.log("WebSocket connected",n.id),d(!0),n.emit("join-tracking",{deliveryId:t,userId:r})}),n.on("connect_error",e=>{var t;console.error("WebSocket connection error:",e),null==(t=v.current)||t.call(v,"Connection error: ".concat(e.message))}),n.on("disconnect",e=>{console.log("WebSocket disconnected:",e),d(!1)}),n.on("tracking-data",e=>{var t;console.log("Received tracking data:",e),p(e),null==(t=f.current)||t.call(f,e)}),n.on("location-updated",e=>{var t;console.log("Location updated:",e.pickerLocation),null==(t=g.current)||t.call(g,e.pickerLocation),p(t=>t?{...t,pickerLocation:e.pickerLocation}:null)}),n.on("status-updated",e=>{var t;console.log("Status updated:",e.status),null==(t=x.current)||t.call(x,e.status),p(t=>t?{...t,status:e.status}:null)}),n.on("tracking-completed",e=>{var t;console.log("Tracking completed for delivery:",e.deliveryId),null==(t=x.current)||t.call(x,"delivered")}),n.on("error",e=>{var t;console.error("WebSocket error:",e.message),null==(t=v.current)||t.call(v,e.message)}),i.current=n}catch(e){console.error("Failed to connect WebSocket:",e),null==(a=v.current)||a.call(v,"Failed to connect to tracking server")}})(),()=>{i.current&&(i.current.emit("leave-tracking",{deliveryId:t}),i.current.disconnect(),i.current=null)}},[a,t,r]),{isConnected:u,trackingData:h,sendLocationUpdate:(0,n.useCallback)((e,a)=>{var n;(null==(n=i.current)?void 0:n.connected)&&i.current.emit("update-location",{deliveryId:t,lat:e,lng:a,userId:r})},[t,r]),sendStatusUpdate:(0,n.useCallback)(e=>{var a;(null==(a=i.current)?void 0:a.connected)&&i.current.emit("update-status",{deliveryId:t,status:e,userId:r})},[t,r])}},S=(0,l.default)(()=>Promise.all([r.e(9484),r.e(1761),r.e(5388)]).then(r.bind(r,5388)),{loadableGenerated:{webpack:()=>[5388]},ssr:!1,loading:()=>(0,a.jsx)(o.default,{sx:{height:"60vh",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,a.jsx)(s.default,{})})});function W(){let e=(0,c.useParams)(),t=null==e?void 0:e.deliveryId,[r,l]=(0,n.useState)(null),[k,w]=(0,n.useState)(null),[A,W]=(0,n.useState)(null),[E,R]=(0,n.useState)(null),[L,C]=(0,n.useState)(!0),[P,N]=(0,n.useState)(""),[T,M]=(0,n.useState)(null),[z,D]=(0,n.useState)(!1);(0,n.useEffect)(()=>{(async()=>{try{let e=await (0,b.HW)();M(e.user)}catch(e){console.error("Error loading current user:",e)}})()},[]);let B=T&&k&&T.id===k.id;(e=>{let{deliveryId:t,userId:r,enabled:a,onPermissionDenied:c,onPermissionGranted:l}=e,o=(0,n.useRef)(null),s=(0,n.useRef)(null),i=(0,n.useRef)(0),u=(0,n.useRef)(null),{sendLocationUpdate:d,isConnected:h}=I({deliveryId:t,userId:r,enabled:a}),p=(0,n.useCallback)((e,t,r,a)=>{let n=e*Math.PI/180,c=r*Math.PI/180,l=(r-e)*Math.PI/180,o=(a-t)*Math.PI/180,s=Math.sin(l/2)*Math.sin(l/2)+Math.cos(n)*Math.cos(c)*Math.sin(o/2)*Math.sin(o/2);return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371e3},[]),g=(0,n.useCallback)((e,t)=>!s.current||p(s.current.lat,s.current.lng,e,t)>5,[p]),x=(0,n.useCallback)(()=>{null!==o.current&&(navigator.geolocation.clearWatch(o.current),o.current=null),o.current=navigator.geolocation.watchPosition(e=>{i.current+=1;let{latitude:t,longitude:r}=e.coords;1===i.current&&(null==l||l());let a=s.current;s.current={lat:t,lng:r};let n=g(t,r);(!a||n)&&d(t,r)},e=>{e.code===e.PERMISSION_DENIED&&(null==c||c(),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{x()},1e4))},{enableHighAccuracy:!0,timeout:3e4,maximumAge:5e3})},[g,d,c]);return(0,n.useEffect)(()=>{if(!a||!h){null!==o.current&&(navigator.geolocation.clearWatch(o.current),o.current=null),u.current&&(clearTimeout(u.current),u.current=null);return}if(!navigator.geolocation)return;let e=()=>{};return document.addEventListener("visibilitychange",e),x(),()=>{null!==o.current&&(navigator.geolocation.clearWatch(o.current),o.current=null),u.current&&(clearTimeout(u.current),u.current=null),document.removeEventListener("visibilitychange",e)}},[a,h,x])})({deliveryId:Number(t),userId:(null==T?void 0:T.id)||0,enabled:!!B&&(null==r?void 0:r.status)==="picked_up",onPermissionDenied:()=>{D(!1)},onPermissionGranted:()=>{D(!0)}});let{isConnected:q}=I({deliveryId:Number(t),userId:(null==T?void 0:T.id)||0,enabled:!!T&&!!r,onLocationUpdate:e=>{console.log("Picker location updated via WebSocket:",e),W({lat:e.lat,lng:e.lng})},onStatusUpdate:e=>{console.log("Delivery status updated via WebSocket:",e),r&&l({...r,status:e})},onTrackingData:e=>{console.log("Received full tracking data:",e),e.pickerLocation&&W({lat:e.pickerLocation.lat,lng:e.pickerLocation.lng})},onError:e=>{console.error("WebSocket error:",e),N(e)}});(0,n.useEffect)(()=>{(async()=>{try{C(!0);let e=await (0,j.IT)(Number(t));if(l(e.data),e.data.pickerId){let t=await (0,b.wz)(e.data.pickerId);w(t.user),t.user.location&&W(t.user.location)}C(!1)}catch(e){console.error("Error loading delivery:",e),N(e.message||"Failed to load delivery information"),C(!1)}})()},[t]);let _=async(e,t)=>{try{let r="https://router.project-osrm.org/route/v1/driving/".concat(e.lng,",").concat(e.lat,";").concat(t.lng,",").concat(t.lat,"?overview=full&geometries=geojson"),a=await fetch(r),n=await a.json();if("Ok"!==n.code||!n.routes||0===n.routes.length)return{distance:"N/A",duration:"N/A",coordinates:[[e.lat,e.lng],[t.lat,t.lng]]};let c=n.routes[0],l=c.geometry.coordinates.map(e=>[e[1],e[0]]);return{distance:"".concat((c.distance/1e3).toFixed(1)," km"),duration:"".concat(Math.round(c.duration/60)," min"),coordinates:l}}catch(r){return console.error("Route calculation error:",r),{distance:"N/A",duration:"N/A",coordinates:[[e.lat,e.lng],[t.lat,t.lng]]}}};return((0,n.useEffect)(()=>{A&&(null==r?void 0:r.toLocation)&&(async()=>{try{let e=await _(A,r.toLocation);R(e)}catch(e){console.error("Error calculating route:",e)}})()},[A,null==r?void 0:r.toLocation]),L)?(0,a.jsx)(o.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},children:(0,a.jsx)(s.default,{})}):P||!r?(0,a.jsx)(o.default,{sx:{p:2},children:(0,a.jsx)(i.A,{severity:"error",children:P||"Delivery not found"})}):(0,a.jsxs)(o.default,{sx:{p:2,maxWidth:"1200px",margin:"0 auto"},children:[(0,a.jsxs)(u.A,{sx:{p:2,mb:2},children:[(0,a.jsxs)(o.default,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[(0,a.jsx)(d.default,{variant:"h5",children:"Delivery Tracking"}),(0,a.jsx)(h.A,{icon:q&&(z||!B)?(0,a.jsx)(g.A,{}):(0,a.jsx)(x.A,{}),label:q&&(z||!B)?"Live Tracking":q&&!z&&B?"Permission Denied":"Connecting...",color:q&&(z||!B)?"success":q&&!z&&B?"error":"default",size:"small"})]}),(0,a.jsxs)(o.default,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[(0,a.jsx)(h.A,{label:r.status.replace("_"," ").toUpperCase(),color:(e=>{switch(e){case"pending":return"warning";case"accepted":return"info";case"picked_up":return"primary";case"delivered":return"success";case"cancelled":return"error";default:return"default"}})(r.status),size:"small"}),E&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(h.A,{icon:(0,a.jsx)(f.A,{}),label:"Distance: ".concat(E.distance),size:"small",variant:"outlined"}),(0,a.jsx)(h.A,{icon:(0,a.jsx)(v.A,{}),label:"ETA: ".concat(E.duration),size:"small",variant:"outlined"})]})]})]}),(0,a.jsx)(u.A,{sx:{mb:2,overflow:"hidden",borderRadius:2},children:(0,a.jsx)(S,{delivery:r,picker:k,pickerLocation:A,route:E})}),(0,a.jsxs)(u.A,{sx:{p:2,mb:2},children:[(0,a.jsx)(d.default,{variant:"h6",gutterBottom:!0,children:r.title}),r.description&&(0,a.jsx)(d.default,{variant:"body2",color:"text.secondary",sx:{mb:2},children:r.description}),(0,a.jsxs)(o.default,{sx:{display:"flex",gap:2,flexWrap:"wrap",mt:2},children:[(0,a.jsxs)(o.default,{children:[(0,a.jsx)(d.default,{variant:"caption",color:"text.secondary",children:"Size"}),(0,a.jsx)(d.default,{variant:"body2",fontWeight:600,children:r.size})]}),(0,a.jsxs)(o.default,{children:[(0,a.jsx)(d.default,{variant:"caption",color:"text.secondary",children:"Price"}),(0,a.jsxs)(d.default,{variant:"body2",fontWeight:600,children:["$",r.price]})]}),r.weight&&(0,a.jsxs)(o.default,{children:[(0,a.jsx)(d.default,{variant:"caption",color:"text.secondary",children:"Weight"}),(0,a.jsxs)(d.default,{variant:"body2",fontWeight:600,children:[r.weight," kg"]})]})]})]}),k&&(0,a.jsxs)(u.A,{sx:{p:2},children:[(0,a.jsxs)(d.default,{variant:"subtitle1",gutterBottom:!0,fontWeight:600,children:[(0,a.jsx)(y.default,{})," Courier Information"]}),(0,a.jsxs)(o.default,{sx:{display:"flex",gap:2,alignItems:"center"},children:[(0,a.jsx)(p.default,{src:k.avatarUrl,sx:{width:60,height:60},children:k.name.charAt(0)}),(0,a.jsxs)(o.default,{children:[(0,a.jsx)(d.default,{variant:"body1",fontWeight:600,children:k.name}),(0,a.jsxs)(o.default,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(0,a.jsx)(m.default,{fontSize:"small",sx:{color:"gold"}}),(0,a.jsx)(d.default,{variant:"body2",children:k.rating?Number(k.rating).toFixed(1):"N/A"}),(0,a.jsxs)(d.default,{variant:"caption",color:"text.secondary",children:["(",k.totalRatings||0," ratings)"]})]}),(0,a.jsxs)(d.default,{variant:"body2",color:"text.secondary",children:[k.completedDeliveries||0," completed deliveries"]})]})]})]})]})}},70118:(e,t,r)=>{Promise.resolve().then(r.bind(r,67780))}},e=>{e.O(0,[3965,7225,9313,1623,1101,5458,8441,5964,7358],()=>e(e.s=70118)),_N_E=e.O()}]);