"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5053],{3376:(e,t,r)=>{r.d(t,{E:()=>i,c:()=>u});var n=r(12115),c=r(14298),a=r(28069),o=r(6267),l=r(87358);let i=e=>{let{deliveryId:t,userId:r,enabled:i,onLocationUpdate:u,onStatusUpdate:s,onTrackingData:d,onError:p}=e,h=(0,n.useRef)(null),[g,v]=(0,n.useState)(!1),[y,m]=(0,n.useState)(null),k=(0,n.useRef)(u),b=(0,n.useRef)(s),f=(0,n.useRef)(d),x=(0,n.useRef)(p);return(0,n.useEffect)(()=>{k.current=u,b.current=s,f.current=d,x.current=p},[u,s,d,p]),(0,n.useEffect)(()=>{if(i)return(async()=>{var e,n;try{let n=await (0,a.c4)();if(!n){null==(e=x.current)||e.call(x,"Authentication token not found");return}let i=o.Ii.isNativePlatform()?"https://pickom.qirelab.com":l.env.NEXT_PUBLIC_API_URL||"https://pickom.qirelab.com",u=(0,c.io)("".concat(i,"/tracking"),{transportOptions:{polling:{extraHeaders:{Authorization:"Bearer ".concat(n)}}},extraHeaders:{Authorization:"Bearer ".concat(n)},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});u.on("connect",()=>{console.log("WebSocket connected",u.id),v(!0),u.emit("join-tracking",{deliveryId:t,userId:r})}),u.on("connect_error",e=>{var t;console.error("WebSocket connection error:",e),null==(t=x.current)||t.call(x,"Connection error: ".concat(e.message))}),u.on("disconnect",e=>{console.log("WebSocket disconnected:",e),v(!1)}),u.on("tracking-data",e=>{var t;console.log("Received tracking data:",e),m(e),null==(t=f.current)||t.call(f,e)}),u.on("location-updated",e=>{var t;console.log("Location updated:",e.pickerLocation),null==(t=k.current)||t.call(k,e.pickerLocation),m(t=>t?{...t,pickerLocation:e.pickerLocation}:null)}),u.on("status-updated",e=>{var t;console.log("Status updated:",e.status),null==(t=b.current)||t.call(b,e.status),m(t=>t?{...t,status:e.status}:null)}),u.on("tracking-completed",e=>{var t;console.log("Tracking completed for delivery:",e.deliveryId),null==(t=b.current)||t.call(b,"delivered")}),u.on("error",e=>{var t;console.error("WebSocket error:",e.message),null==(t=x.current)||t.call(x,e.message)}),h.current=u}catch(e){console.error("Failed to connect WebSocket:",e),null==(n=x.current)||n.call(x,"Failed to connect to tracking server")}})(),()=>{h.current&&(h.current.emit("leave-tracking",{deliveryId:t}),h.current.disconnect(),h.current=null)}},[i,t,r]),{isConnected:g,trackingData:y,sendLocationUpdate:(0,n.useCallback)((e,n)=>{var c;(null==(c=h.current)?void 0:c.connected)&&h.current.emit("update-location",{deliveryId:t,lat:e,lng:n,userId:r})},[t,r]),sendStatusUpdate:(0,n.useCallback)(e=>{var n;(null==(n=h.current)?void 0:n.connected)&&h.current.emit("update-status",{deliveryId:t,status:e,userId:r})},[t,r])}},u=e=>{let{deliveryId:t,userId:r,enabled:c,onPermissionDenied:a,onPermissionGranted:o}=e,l=(0,n.useRef)(null),u=(0,n.useRef)(null),s=(0,n.useRef)(0),d=(0,n.useRef)(null),{sendLocationUpdate:p,isConnected:h}=i({deliveryId:t,userId:r,enabled:c}),g=(0,n.useCallback)((e,t,r,n)=>{let c=e*Math.PI/180,a=r*Math.PI/180,o=(r-e)*Math.PI/180,l=(n-t)*Math.PI/180,i=Math.sin(o/2)*Math.sin(o/2)+Math.cos(c)*Math.cos(a)*Math.sin(l/2)*Math.sin(l/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371e3},[]),v=(0,n.useCallback)((e,t)=>!u.current||g(u.current.lat,u.current.lng,e,t)>5,[g]),y=(0,n.useCallback)(()=>{null!==l.current&&(navigator.geolocation.clearWatch(l.current),l.current=null),l.current=navigator.geolocation.watchPosition(e=>{s.current+=1;let{latitude:t,longitude:r}=e.coords;1===s.current&&(null==o||o());let n=u.current;u.current={lat:t,lng:r};let c=v(t,r);(!n||c)&&p(t,r)},e=>{e.code===e.PERMISSION_DENIED&&(null==a||a(),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{y()},1e4))},{enableHighAccuracy:!0,timeout:3e4,maximumAge:5e3})},[v,p,a]);return(0,n.useEffect)(()=>{if(!c||!h){null!==l.current&&(navigator.geolocation.clearWatch(l.current),l.current=null),d.current&&(clearTimeout(d.current),d.current=null);return}if(!navigator.geolocation)return;let e=()=>{};return document.addEventListener("visibilitychange",e),y(),()=>{null!==l.current&&(navigator.geolocation.clearWatch(l.current),l.current=null),d.current&&(clearTimeout(d.current),d.current=null),document.removeEventListener("visibilitychange",e)}},[c,h,y]),{isConnected:h,requestLocationPermission:y}}},6864:(e,t,r)=>{r.d(t,{$H:()=>l,HW:()=>o,TK:()=>a,op:()=>i,wz:()=>c});var n=r(51070);let c=async e=>(await n.xh.get("/user/".concat(e))).data,a=async(e,t)=>(await n.xh.put("/user/".concat(e),t)).data,o=async()=>(await n.xh.get("/auth/me")).data,l=async(e,t)=>(await n.xh.put("/user/".concat(e,"/online-status"),{isOnline:t})).data,i=async e=>(await n.xh.get("/user/".concat(e,"/balance"))).data},14140:(e,t,r)=>{r.d(t,{j:()=>o});var n=r(23915),c=r(45404);let a=(0,n.Wp)({apiKey:"AIzaSyDiclg8XNo2L1hDBoaSoHmFMBggUKYjHH4",authDomain:"pickom-mvp.firebaseapp.com",projectId:"pickom-mvp",storageBucket:"pickom-mvp.firebasestorage.app",messagingSenderId:"168767828055",appId:"1:168767828055:web:2853961b44970c114ab312"}),o=(0,c.xI)(a)},21787:(e,t,r)=>{r.d(t,{IT:()=>i,S1:()=>p,TS:()=>v,XE:()=>u,confirmRecipient:()=>h,createDeliveryRequest:()=>o,fI:()=>a,qM:()=>d,rg:()=>g,updateDeliveryRequest:()=>s,vd:()=>c,zW:()=>l});var n=r(51070);let c=async()=>n.Bb.get("/delivery/pickers"),a=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"within-city";return n.Bb.get("/delivery/pickers/nearby?lat=".concat(e,"&lng=").concat(t,"&deliveryType=").concat(r))},o=async e=>n.xh.post("/delivery/requests",e),l=async()=>n.xh.get("/delivery/requests"),i=async e=>n.xh.get("/delivery/requests/".concat(e)),u=async(e,t)=>n.xh.put("/delivery/requests/".concat(e,"/status"),{status:t}),s=async(e,t)=>n.xh.patch("/delivery/requests/".concat(e),t),d=async()=>n.xh.get("/delivery/completed"),p=async()=>n.xh.get("/delivery/cancelled"),h=async(e,t)=>n.xh.put("/delivery/requests/".concat(e,"/confirm-recipient"),{confirmed:t}),g=async e=>n.xh.post("/delivery/find-receiver",{email:e}),v=async()=>n.xh.get("/delivery/incoming")},28069:(e,t,r)=>{r.d(t,{Nq:()=>i,c4:()=>a,mH:()=>l,mg:()=>o,vx:()=>u});var n=r(51070),c=r(14140);let a=async()=>{let e=c.j.currentUser;return e?await e.getIdToken():null},o=async e=>n.Bb.post("/auth/login",{},{headers:{Authorization:"Bearer ".concat(e)}}),l=async(e,t,r,c)=>n.Bb.post("/auth/register",{role:e,phone:r,name:c},{headers:{Authorization:"Bearer ".concat(t)}}),i=async()=>n.xh.get("/auth/me"),u=async()=>n.xh.post("/auth/logout")},51070:(e,t,r)=>{r.d(t,{Bb:()=>u,xh:()=>i,y3:()=>s});var n=r(23464),c=r(14140),a=r(6267),o=r(87358);let l=a.Ii.isNativePlatform()?"https://pickom.qirelab.com":o.env.NEXT_PUBLIC_API_URL||"https://pickom.qirelab.com",i=n.A.create({baseURL:l,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});i.interceptors.request.use(async e=>{let t=c.j.currentUser;if(t)try{let r=await t.getIdToken();e.headers.Authorization="Bearer ".concat(r)}catch(e){}return e},e=>Promise.reject(e)),i.interceptors.response.use(e=>e,e=>Promise.reject(e));let u=n.A.create({baseURL:l,withCredentials:!0,timeout:3e4,headers:{"Content-Type":"application/json"}});async function s(){try{return await n.A.get("".concat(l,"/api"),{timeout:5e3}),!0}catch(e){return!1}}u.interceptors.response.use(e=>e,e=>Promise.reject(e))}}]);