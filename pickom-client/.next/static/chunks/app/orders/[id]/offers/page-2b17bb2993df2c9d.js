(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1294],{3447:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>P});var a=r(95155),i=r(12115),l=r(54581),n=r(71116),o=r(3127),c=r(70541),d=r(18096),s=r(14426),f=r(92302),u=r(36114),p=r(54492),h=r(99927),x=r(76871),j=r(71977),y=r(68534),b=r(38464),g=r(57773),m=r(35695),v=r(43452),A=r(97704),k=r(47075),C=r(78780),w=r(21787),I=r(6864),F=r(16509),N=r(28069);function P(e){let{params:t}=e,r=(0,i.use)(t),P=(0,m.useRouter)(),S=Number(r.id),[W,T]=(0,i.useState)([]),[q,O]=(0,i.useState)(0),[R,D]=(0,i.useState)(!0),[_,B]=(0,i.useState)(""),[E,z]=(0,i.useState)("all"),[M,U]=(0,i.useState)(0),[H,V]=(0,i.useState)(""),[Y,$]=(0,i.useState)({open:!1,type:null,offerId:null}),[L,G]=(0,i.useState)({open:!1,required:0,current:0}),[J,K]=(0,i.useState)(!1);(0,i.useEffect)(()=>{(async()=>{D(!0),B("");try{let e=(await (0,N.Nq)()).data.user;V(e.uid);let t=await (0,I.op)(e.uid);U(Number(t.balance)||0);let r=await (0,w.IT)(S);O(r.data.price);let a=(await (0,C.F8)(S)).data,i=await Promise.all(a.map(async e=>{try{let t=(await (0,I.wz)(e.pickerId)).user,r={uid:t.uid,fullName:t.name,avatarUrl:t.avatarUrl,rating:4.5,reviewCount:42,completedDeliveries:100,vehicle:"Car",isVerified:!0,isPhoneVerified:!!t.phone,isEmailVerified:!0,trustLevel:85};return{...e,picker:r}}catch(t){return console.error("Failed to fetch picker data for offer ".concat(e.id,":"),t),e}}));T(i)}catch(e){console.error("Failed to fetch offers:",e),B("Failed to load offers. Please try again.")}finally{D(!1)}})()},[S]);let Q=(0,i.useMemo)(()=>"all"===E?W:W.filter(e=>e.status===E),[W,E]),X=async e=>{try{let{chatId:t}=(await (0,F.createChat)({participantId:e,deliveryId:S})).data;P.push("/chat/".concat(t))}catch(e){console.error("Failed to create chat:",e),alert("Failed to open chat. Please try again.")}},Z=async e=>{let t=W.find(t=>t.id===e);if(!t)return void alert("Offer not found");try{let r=await (0,I.op)(H),a=Number(r.balance)||0;if(U(a),a<t.price)return void G({open:!0,required:t.price,current:a});$({open:!0,type:"accept",offerId:e})}catch(e){console.error("Failed to check balance:",e),alert("Failed to verify balance. Please try again.")}},ee=async()=>{if(Y.offerId){K(!0);try{let e="accept"===Y.type?"accepted":"rejected",t=W.find(e=>e.id===Y.offerId);if(!t)return void alert("Offer not found");if(await (0,C.i6)(Y.offerId,{status:e}),"accept"===Y.type){await (0,w.updateDeliveryRequest)(S,{pickerId:t.pickerId,status:"accepted"});let e=W.filter(e=>e.id!==Y.offerId&&"pending"===e.status);await Promise.all(e.map(e=>(0,C.i6)(e.id,{status:"rejected"}))),alert("Offer accepted! The picker has been assigned and other offers have been rejected."),P.push("/orders/".concat(S))}else T(e=>e.map(e=>e.id===Y.offerId?{...e,status:"rejected"}:e)),alert("Offer rejected. The picker has been notified.")}catch(e){console.error("Failed to update offer:",e),alert("Failed to update offer. Please try again.")}finally{K(!1),$({open:!1,type:null,offerId:null})}}},et=()=>{$({open:!1,type:null,offerId:null})},er=(0,i.useMemo)(()=>({all:W.length,pending:W.filter(e=>"pending"===e.status).length,accepted:W.filter(e=>"accepted"===e.status).length,rejected:W.filter(e=>"rejected"===e.status).length}),[W]);return(0,a.jsx)(l.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f5f5f5",p:2},children:(0,a.jsxs)(l.default,{sx:{position:"relative",width:"100%",maxWidth:375,height:812},children:[(0,a.jsx)(v.MobileContainer,{showFrame:!1,children:(0,a.jsxs)(l.default,{sx:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"background.default"},children:[(0,a.jsxs)(l.default,{sx:{display:"flex",alignItems:"center",gap:1,p:2,borderBottom:1,borderColor:"divider"},children:[(0,a.jsx)(o.A,{onClick:()=>{P.push("/orders/".concat(S))},size:"small",children:(0,a.jsx)(b.A,{})}),(0,a.jsx)(g.A,{sx:{color:"primary.main"}}),(0,a.jsxs)(n.default,{variant:"h6",sx:{fontWeight:600,flex:1},children:["Delivery #",S," - Offers"]})]}),(0,a.jsxs)(c.A,{value:E,onChange:(e,t)=>{z(t)},variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:48,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem",fontWeight:500,textTransform:"none"}},children:[(0,a.jsx)(d.A,{label:"All (".concat(er.all,")"),value:"all"}),(0,a.jsx)(d.A,{label:"Pending (".concat(er.pending,")"),value:"pending"}),(0,a.jsx)(d.A,{label:"Accepted (".concat(er.accepted,")"),value:"accepted"}),(0,a.jsx)(d.A,{label:"Rejected (".concat(er.rejected,")"),value:"rejected"})]}),(0,a.jsx)(l.default,{sx:{flex:1,overflow:"auto",pb:8},children:R?(0,a.jsx)(l.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:8},children:(0,a.jsx)(s.default,{})}):_?(0,a.jsx)(l.default,{sx:{p:3},children:(0,a.jsx)(f.A,{severity:"error",children:_})}):0===Q.length?(()=>{let e={all:{icon:"\uD83D\uDCED",title:"No offers yet",description:"Pickers will see your delivery and can make offers."},pending:{icon:"⏳",title:"No pending offers",description:"All offers have been reviewed."},accepted:{icon:"✅",title:"No accepted offers",description:"Accepted offers will appear here."},rejected:{icon:"❌",title:"No rejected offers",description:"Rejected offers will appear here."}}[E];return(0,a.jsxs)(l.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:8,px:3},children:[(0,a.jsx)(n.default,{sx:{fontSize:"4rem",mb:2},children:e.icon}),(0,a.jsx)(n.default,{variant:"h6",sx:{fontWeight:600,mb:1,textAlign:"center"},children:e.title}),(0,a.jsx)(n.default,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:e.description})]})})():(0,a.jsx)(l.default,{sx:{p:2},children:Q.map(e=>e.picker?(0,a.jsx)(k.A,{offer:e,picker:e.picker,originalPrice:q,onChat:()=>X(e.pickerId),onAccept:()=>Z(e.id),onReject:()=>{$({open:!0,type:"reject",offerId:e.id})},disabled:J},e.id):(0,a.jsx)(l.default,{sx:{p:2,mb:2},children:(0,a.jsxs)(f.A,{severity:"warning",children:["Unable to load picker data for offer #",e.id]})},e.id))})})]})}),(0,a.jsx)(A.default,{}),(0,a.jsxs)(u.A,{open:Y.open,onClose:et,maxWidth:"xs",fullWidth:!0,children:[(0,a.jsx)(p.A,{children:"accept"===Y.type?"Accept Offer?":"Reject Offer?"}),(0,a.jsx)(h.A,{children:(0,a.jsx)(x.A,{children:"accept"===Y.type?(0,a.jsx)(a.Fragment,{children:"You are about to accept this offer. The picker will be assigned to your delivery and all other pending offers will be automatically rejected."}):(0,a.jsx)(a.Fragment,{children:"You are about to reject this offer. The picker will be notified. This action cannot be undone."})})}),(0,a.jsxs)(j.A,{sx:{px:3,py:2},children:[(0,a.jsx)(y.A,{onClick:et,variant:"outlined",disabled:J,children:"Cancel"}),(0,a.jsx)(y.A,{onClick:ee,variant:"contained",color:"accept"===Y.type?"success":"error",disabled:J,children:J?"Processing...":"accept"===Y.type?"Accept":"Reject"})]})]}),(0,a.jsxs)(u.A,{open:L.open,onClose:()=>G({open:!1,required:0,current:0}),maxWidth:"xs",fullWidth:!0,children:[(0,a.jsx)(p.A,{sx:{color:"error.main"},children:"Insufficient Balance"}),(0,a.jsxs)(h.A,{children:[(0,a.jsx)(x.A,{sx:{mb:2},children:"You don't have enough balance to accept this offer. Please top up your account to continue."}),(0,a.jsxs)(l.default,{sx:{backgroundColor:"grey.100",p:2,borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[(0,a.jsxs)(l.default,{sx:{display:"flex",justifyContent:"space-between"},children:[(0,a.jsx)(n.default,{variant:"body2",color:"text.secondary",children:"Current Balance:"}),(0,a.jsxs)(n.default,{variant:"body2",fontWeight:600,children:["$",L.current.toFixed(2)]})]}),(0,a.jsxs)(l.default,{sx:{display:"flex",justifyContent:"space-between"},children:[(0,a.jsx)(n.default,{variant:"body2",color:"text.secondary",children:"Required Amount:"}),(0,a.jsxs)(n.default,{variant:"body2",fontWeight:600,color:"error",children:["$",L.required.toFixed(2)]})]}),(0,a.jsxs)(l.default,{sx:{display:"flex",justifyContent:"space-between",pt:1,borderTop:1,borderColor:"divider"},children:[(0,a.jsx)(n.default,{variant:"body2",color:"text.secondary",children:"Need to Add:"}),(0,a.jsxs)(n.default,{variant:"body1",fontWeight:700,color:"primary",children:["$",(L.required-L.current).toFixed(2)]})]})]})]}),(0,a.jsxs)(j.A,{sx:{px:3,py:2},children:[(0,a.jsx)(y.A,{onClick:()=>G({open:!1,required:0,current:0}),variant:"outlined",children:"Cancel"}),(0,a.jsx)(y.A,{onClick:()=>P.push("/earnings/top-up"),variant:"contained",color:"primary",children:"Top Up Balance"})]})]})]})})}},23174:(e,t,r)=>{Promise.resolve().then(r.bind(r,3447))}},e=>{e.O(0,[3965,7225,8795,4611,8534,5207,1101,1190,9283,7262,9815,5409,8441,5964,7358],()=>e(e.s=23174)),_N_E=e.O()}]);