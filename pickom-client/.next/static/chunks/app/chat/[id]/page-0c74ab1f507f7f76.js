(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6509,8877],{16509:(e,t,a)=>{"use strict";a.d(t,{TJ:()=>i,_z:()=>l,createChat:()=>r,iS:()=>c,m7:()=>d,ug:()=>n});var s=a(51070);let r=async e=>s.x.post("/chat/create",e),n=async()=>s.x.get("/chat"),d=async e=>s.x.get("/chat/delivery/".concat(e)),i=async e=>s.x.get("/chat/".concat(e)),l=async(e,t)=>s.x.post("/chat/".concat(e,"/messages"),t),c=async e=>s.x.patch("/chat/".concat(e,"/messages/mark-read"))},64617:(e,t,a)=>{Promise.resolve().then(a.bind(a,98961))},98961:(e,t,a)=>{"use strict";a.d(t,{ChatPageClient:()=>v});var s=a(95155),r=a(12115),n=a(54581),d=a(14426),i=a(92302),l=a(72705),c=a(3127),o=a(71116),m=a(38464);let h=(0,a(31418).A)((0,s.jsx)("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send");var u=a(35695),x=a(43452),f=a(58343),g=a(50276),p=a(70541),y=a(18096),b=a(26564),j=a(16509);function I(e){let{senderChatId:t,receiverChatId:a,currentUserUid:d}=e,[i,o]=(0,r.useState)("sender"),[m,u]=(0,r.useState)(null),[x,I]=(0,r.useState)(null),[k,v]=(0,r.useState)([]),[S,C]=(0,r.useState)([]),[w,A]=(0,r.useState)(""),[F,N]=(0,r.useState)(!1),[D,P]=(0,r.useState)(0),[z,E]=(0,r.useState)(0),T=(0,r.useCallback)(async(e,t)=>{try{let a=(await (0,j.TJ)(e)).data;if(t){if(u(a),a.messages){let e=a.messages.map(e=>({id:e.id,senderId:e.senderId,senderName:e.senderName,content:e.content,timestamp:new Date(e.createdAt),isFromPicker:e.senderId===a.pickerId,chatSessionId:e.chatSessionId,attachments:e.attachments,read:e.read,createdAt:new Date(e.createdAt)}));v(e)}P(a.unreadCount||0)}else{if(I(a),a.messages){let e=a.messages.map(e=>({id:e.id,senderId:e.senderId,senderName:e.senderName,content:e.content,timestamp:new Date(e.createdAt),isFromPicker:e.senderId===a.pickerId,chatSessionId:e.chatSessionId,attachments:e.attachments,read:e.read,createdAt:new Date(e.createdAt)}));C(e)}E(a.unreadCount||0)}}catch(e){console.error("Failed to fetch chat:",e)}},[]);(0,r.useEffect)(()=>{T(t,!0),a&&T(a,!1)},[t,a,T]),(0,r.useEffect)(()=>{(async()=>{try{"sender"===i?(await (0,j.iS)(t),P(0)):a&&(await (0,j.iS)(a),E(0))}catch(e){console.error("Failed to mark messages as read:",e)}})()},[i,t,a]);let _=(0,r.useCallback)(async()=>{if(!w.trim()||F)return;let e="sender"===i?t:a;if(!e)return;let s="sender"===i?m:x;if(s){N(!0);try{let t=(await (0,j._z)(e,{content:w.trim()})).data,a={id:t.id,senderId:t.senderId,senderName:t.senderName,content:t.content,timestamp:new Date(t.createdAt),isFromPicker:t.senderId===s.pickerId,chatSessionId:t.chatSessionId,attachments:t.attachments,read:t.read,createdAt:new Date(t.createdAt)};"sender"===i?v(e=>[...e,a]):C(e=>[...e,a]),A("")}catch(e){console.error("Failed to send message:",e),alert("Failed to send message. Please try again.")}finally{N(!1)}}},[w,F,i,t,a,m,x]),H="sender"===i?k:S,B="sender"===i?m:x,K=B?(B.pickerId,H.map(e=>({id:e.id,text:e.content,timestamp:e.timestamp,sender:{id:e.senderId,name:e.senderName,type:e.isFromPicker?"picker":"customer"},isOwn:e.senderId===d}))):[];return(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[(0,s.jsx)(n.default,{sx:{borderBottom:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(p.A,{value:i,onChange:(e,t)=>o(t),children:[(0,s.jsx)(y.A,{label:(0,s.jsx)(b.default,{badgeContent:D,color:"error",children:"Sender"}),value:"sender"}),a&&(0,s.jsx)(y.A,{label:(0,s.jsx)(b.default,{badgeContent:z,color:"error",children:"Receiver"}),value:"receiver"})]})}),(0,s.jsx)(n.default,{sx:{flex:1,overflow:"hidden",mx:2},children:(0,s.jsx)(g.as,{messages:K,height:"100%"})}),(0,s.jsx)(n.default,{sx:{p:2,borderTop:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(l.A,{direction:"row",spacing:1,alignItems:"flex-end",children:[(0,s.jsx)(f.ks,{value:w,onChange:e=>A(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())},placeholder:"Type your message...",disabled:F,multiline:!0,maxRows:3,size:"small",sx:{flex:1}}),(0,s.jsx)(c.A,{onClick:_,disabled:!w.trim()||F,sx:{bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"},"&:disabled":{bgcolor:"action.disabledBackground",color:"action.disabled"}},children:(0,s.jsx)(h,{fontSize:"small"})})]})})]})}var k=a(6864);function v(e){let{chatId:t}=e,a=(0,u.useRouter)(),[p,y]=(0,r.useState)(null),[b,v]=(0,r.useState)([]),[S,C]=(0,r.useState)(""),[w,A]=(0,r.useState)(!0),[F,N]=(0,r.useState)(""),[D,P]=(0,r.useState)(!1),[z,E]=(0,r.useState)(""),[T,_]=(0,r.useState)(""),[H,B]=(0,r.useState)(""),[K,O]=(0,r.useState)();(0,r.useEffect)(()=>{(async()=>{try{let e=await (0,k.HW)();E(e.user.uid),_(e.user.role)}catch(e){console.error("Failed to fetch current user:",e)}})()},[]),(0,r.useEffect)(()=>{(async()=>{if(T){A(!0),N("");try{let e=(await (0,j.TJ)(t)).data;if(y(e),"picker"===T&&e.deliveryId){let t=(await (0,j.m7)(e.deliveryId)).data,a=t.find(e=>null!==e.senderId&&null===e.recipientId),s=t.find(e=>null!==e.recipientId);a&&B(a.id),s&&O(s.id)}if(e.messages&&"picker"!==T){let t=e.messages.map(t=>({id:t.id,senderId:t.senderId,senderName:t.senderName,content:t.content,timestamp:new Date(t.createdAt),isFromPicker:t.senderId===e.pickerId,chatSessionId:t.chatSessionId,attachments:t.attachments,read:t.read,createdAt:new Date(t.createdAt)}));v(t)}"picker"!==T&&await (0,j.iS)(t)}catch(e){console.error("Failed to fetch chat:",e),N("Failed to load chat. Please try again.")}finally{A(!1)}}})()},[t,T]);let R=(0,r.useCallback)(async()=>{if(S.trim()&&!D){P(!0);try{let e=(await (0,j._z)(t,{content:S.trim()})).data,a={id:e.id,senderId:e.senderId,senderName:e.senderName,content:e.content,timestamp:new Date(e.createdAt),isFromPicker:e.senderId===(null==p?void 0:p.pickerId),chatSessionId:e.chatSessionId,attachments:e.attachments,read:e.read,createdAt:new Date(e.createdAt)};v(e=>[...e,a]),C("")}catch(e){console.error("Failed to send message:",e),alert("Failed to send message. Please try again.")}finally{P(!1)}}},[S,D,t,p]),J=b.map(e=>({id:e.id,text:e.content,timestamp:e.timestamp,sender:{id:e.senderId,name:e.senderName,type:e.isFromPicker?"picker":"customer"},isOwn:e.senderId===z}));return w?(0,s.jsx)(n.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:(0,s.jsx)(d.default,{})}):F?(0,s.jsx)(n.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",p:2},children:(0,s.jsx)(i.A,{severity:"error",children:F})}):p?"picker"===T&&(null==p?void 0:p.deliveryId)&&H?(0,s.jsx)(n.default,{sx:{minHeight:"100vh",bgcolor:"background.default",display:"flex",alignItems:"center",justifyContent:"center",p:2},children:(0,s.jsx)(x.MobileContainer,{showFrame:!1,children:(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[(0,s.jsx)(n.default,{sx:{p:2,borderBottom:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(l.A,{direction:"row",alignItems:"center",spacing:2,children:[(0,s.jsx)(c.A,{onClick:()=>a.push("/chats"),size:"small",sx:{p:1},children:(0,s.jsx)(m.A,{})}),(0,s.jsx)(n.default,{sx:{flex:1},children:(0,s.jsx)(o.default,{variant:"h6",sx:{fontWeight:"bold"},children:"Delivery Chat"})}),(0,s.jsx)(f.Lm,{variant:"icon",size:"small"})]})}),(0,s.jsx)(I,{senderChatId:H,receiverChatId:K,currentUserUid:z})]})})}):(0,s.jsx)(n.default,{sx:{minHeight:"100vh",bgcolor:"background.default",display:"flex",alignItems:"center",justifyContent:"center",p:2},children:(0,s.jsx)(x.MobileContainer,{showFrame:!1,children:(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[(0,s.jsx)(n.default,{sx:{p:2,borderBottom:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(l.A,{direction:"row",alignItems:"center",spacing:2,children:[(0,s.jsx)(c.A,{onClick:()=>a.push("/chats"),size:"small",sx:{p:1},children:(0,s.jsx)(m.A,{})}),(0,s.jsx)(n.default,{sx:{flex:1},children:(0,s.jsx)(o.default,{variant:"h6",sx:{fontWeight:"bold"},children:p&&z?z===p.senderId?p.pickerName||"Picker":p.senderName||"Sender":"Chat"})}),(0,s.jsx)(f.Lm,{variant:"icon",size:"small"})]})}),(0,s.jsx)(n.default,{sx:{flex:1,overflow:"hidden",mx:2},children:(0,s.jsx)(g.as,{messages:J,height:"100%"})}),(0,s.jsx)(n.default,{sx:{p:2,borderTop:1,borderColor:"divider",bgcolor:"background.paper"},children:(0,s.jsxs)(l.A,{direction:"row",spacing:1,alignItems:"flex-end",children:[(0,s.jsx)(f.ks,{value:S,onChange:e=>C(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())},placeholder:"Type your message...",disabled:D,multiline:!0,maxRows:3,size:"small",sx:{flex:1}}),(0,s.jsx)(c.A,{onClick:R,disabled:!S.trim()||D,sx:{bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"},"&:disabled":{bgcolor:"action.disabledBackground",color:"action.disabled"}},children:(0,s.jsx)(h,{fontSize:"small"})})]})})]})})}):(0,s.jsx)(n.default,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",p:2},children:(0,s.jsx)(i.A,{severity:"warning",children:"Chat not found"})})}}},e=>{e.O(0,[6084,3965,7225,8795,4611,8534,5207,1101,8449,1190,9283,1986,7262,2649,7212,1530,2112,9087,8343,9964,9141,8441,5964,7358],()=>e(e.s=64617)),_N_E=e.O()}]);