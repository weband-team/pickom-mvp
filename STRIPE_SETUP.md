# Stripe Payment Integration - Setup Instructions

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ:

### Backend:
- ‚úÖ –í—Å–µ DTO —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ Payment service –æ–±–Ω–æ–≤–ª–µ–Ω (926 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)
- ‚úÖ Payment controller —Å 6 –Ω–æ–≤—ã–º–∏ endpoints
- ‚úÖ User entity: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stripeCustomerId`
- ‚úÖ Delivery entity: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `packageImageUrl`
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

### Frontend:
- ‚úÖ Stripe –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ 5 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ StripeProvider –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ layout
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ /payment-methods —Å–æ–∑–¥–∞–Ω–∞

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

### 1. –ü–æ–ª—É—á–∏—Ç—å Stripe Publishable Key

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://dashboard.stripe.com/test/apikeys
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á "Publishable key" (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `pk_test_`)
3. –û—Ç–∫—Ä–æ–π—Ç–µ `pickom-client/.env`
4. –ó–∞–º–µ–Ω–∏—Ç–µ `pk_test_YOUR_KEY_HERE` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Stripe Secret Key

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ `pickom-server/.env` –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á:
```
STRIPE_SECRET_KEY=sk_test_51SG0N6GyRpOUvZeEM8yeI8UDEfvmdgSYEV5b1uc6Jo7r8OfcLm1FDjTEjiv7zvjstFfiw02MvQ3hAYmvbFvCEVch00eg8Mou8s
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

**Terminal 1 - Backend:**
```bash
cd pickom-server
npm run start:dev
```

**Terminal 2 - Frontend:**
```bash
cd pickom-client
npm run dev
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Stripe:

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∫–∞—Ä—Ç—ã:

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
- –ù–æ–º–µ—Ä: `4242 4242 4242 4242`
- –î–∞—Ç–∞: –ª—é–±–∞—è –±—É–¥—É—â–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12/25)
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123)
- ZIP: –ª—é–±–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12345)

**–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–±—É—é—â–∞—è 3D Secure:**
- –ù–æ–º–µ—Ä: `4000 0025 0000 3155`
- –î–∞—Ç–∞: –ª—é–±–∞—è –±—É–¥—É—â–∞—è
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã

**–ö–∞—Ä—Ç–∞ —Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º:**
- –ù–æ–º–µ—Ä: `4000 0000 0000 0002`

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫: https://stripe.com/docs/testing

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ http://localhost:3000/payment-methods
   - –ù–∞–∂–º–∏—Ç–µ "Add New Card"
   - –í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Å–ø–∏—Å–∫–µ

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ —Å–ø–∏—Å–∫–µ
   - –í—ã–±–µ—Ä–∏—Ç–µ "Set as Default"

3. **–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã:**
   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ —Å–ø–∏—Å–∫–µ
   - –í—ã–±–µ—Ä–∏—Ç–µ "Delete"

4. **–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π:**
   - –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–∞—Ä—Ç—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ

5. **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ endpoint `/payment/topup-balance` —Å `paymentMethodId`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è

## üìù API Endpoints:

### Payment Cards:
```
GET    /payment/cards                    - –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
POST   /payment/cards/setup-intent       - –°–æ–∑–¥–∞—Ç—å Setup Intent
POST   /payment/cards/attach             - –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É
DELETE /payment/cards/:id                - –£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É
PUT    /payment/cards/:id/default        - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

### Payments:
```
POST   /payment/create-intent            - –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ (—Å paymentMethodId)
POST   /payment/topup-balance            - –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (—Å paymentMethodId)
POST   /payment/pay-with-balance         - –û–ø–ª–∞—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–º
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- ‚úÖ –í—Å–µ endpoints –∑–∞—â–∏—â–µ–Ω—ã FirebaseAuthGuard
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ ownership –∫–∞—Ä—Ç –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ PCI DSS compliance —á–µ—Ä–µ–∑ Stripe Elements
- ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç –Ω–∞–ø—Ä—è–º—É—é
- ‚úÖ Database locks –¥–ª—è race condition prevention

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- Stripe Documentation: https://stripe.com/docs
- Stripe Test Cards: https://stripe.com/docs/testing
- Stripe Dashboard: https://dashboard.stripe.com/

## üêõ Troubleshooting:

**–û—à–∏–±–∫–∞: "Stripe is not loaded"**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev server

**–û—à–∏–±–∫–∞: "Payment method does not belong to this user"**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π paymentMethodId
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ DATABASE_URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –∫–∞—Ä—Ç
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è 3D Secure –æ–±—Ä–∞–±–æ—Ç–∫–∞
3. –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π
4. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—É
5. –û–ø–ª–∞—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–º –∞–∫–∫–∞—É–Ω—Ç–∞
6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∞–º–∏ (–¥–æ–±–∞–≤–∏—Ç—å, —É–¥–∞–ª–∏—Ç—å, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
7. International delivery support (packageImageUrl)

## üéâ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Stripe Publishable Key –≤ `.env` –≤—Å–µ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.
