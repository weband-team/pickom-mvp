# Location Permission Flow

## Overview
Реализован механизм запроса разрешения на геолокацию с повторными попытками и UI объяснением для пользователя.

## Компоненты

### 1. `usePickerLocationTracking` Hook
**Файл:** `pickom-client/app/hooks/useWebSocketTracking.ts`

**Изменения:**
- Удален принудительный интервал отправки через `setInterval`
- Локация отправляется только при реальном изменении позиции (>5 метров)
- Добавлен callback `onPermissionDenied` для обработки отказа
- Добавлена функция `requestLocationPermission` для повторного запроса
- Автоматический повторный запрос через 10 секунд после отказа

**Параметры:**
```typescript
{
  deliveryId: number;
  userId: number;
  enabled: boolean;
  onPermissionDenied?: () => void; // Вызывается при отказе
}
```

**Возвращаемое значение:**
```typescript
{
  isConnected: boolean;
  requestLocationPermission: () => void; // Функция для повторного запроса
}
```

### 2. `LocationPermissionDialog` Component
**Файл:** `pickom-client/app/components/LocationPermissionDialog.tsx`

**Описание:**
- Material-UI диалоговое окно с объяснением необходимости геолокации
- Показывает пользователю, зачем нужно разрешение
- Кнопка "Enable Location" для запроса разрешения
- Опциональная кнопка "Not Now" для закрытия

**Props:**
```typescript
{
  open: boolean;
  onRequestPermission: () => void;
  onClose?: () => void;
}
```

### 3. Tracking Page Integration
**Файл:** `pickom-client/app/tracking/[deliveryId]/page.tsx`

**Интеграция:**
- При отказе от геолокации показывается диалог
- Пользователь может вручную запросить разрешение через UI
- Автоматический повторный запрос через 10 секунд (в фоне)

## Поток работы

```
1. Picker открывает страницу tracking
   ↓
2. usePickerLocationTracking запрашивает геолокацию
   ↓
3. Если пользователь отказывает:
   ↓
   → Показывается LocationPermissionDialog
   → Через 10 сек автоматический повторный запрос
   ↓
4. Пользователь может:
   - Нажать "Enable Location" (мгновенный запрос)
   - Нажать "Not Now" (закрыть диалог)
   - Подождать 10 сек (автоматический запрос)
   ↓
5. При разрешении:
   - Начинается отслеживание позиции
   - Отправка при изменении >5 метров
```

## Технические детали

### Отправка локации
- **Только при реальном изменении**: Проверка движения через расчет расстояния
- **Порог движения**: 5 метров (MOVING_THRESHOLD)
- **Без принудительного интервала**: Убран setInterval

### Повторные запросы
- **При отказе**: Автоматический повторный запрос через 10 секунд
- **Ручной запрос**: Через кнопку в диалоге
- **Cleanup**: Таймауты очищаются при размонтировании

### UX соображения
- Объяснение пользователю, зачем нужна геолокация
- Прозрачность: указано, когда и с кем делится локация
- Возможность отложить решение

## Ограничения

⚠️ **Важно**: Браузеры могут блокировать сайт при частых запросах разрешений. Текущая реализация делает:
- 1 автоматический запрос через 10 сек после отказа
- Дальнейшие запросы только по инициативе пользователя

## Тестирование

1. Открыть страницу tracking как picker
2. Отказать в геолокации
3. Должен появиться диалог с объяснением
4. Через 10 сек повторный запрос (автоматически)
5. Можно вручную запросить через кнопку "Enable Location"
