# üì¶ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ (–¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤)

## üéØ –ß—Ç–æ –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏?

–ú—ã —Å–æ–∑–¥–∞–ª–∏ **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É** —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

---

## üìö –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
pickom-server/src/delivery/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ delivery.dto.ts          # DTO –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—É
‚îÇ   ‚îî‚îÄ‚îÄ create-delivery.dto.ts   # DTO –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îî‚îÄ‚îÄ delivery.entity.ts       # –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
‚îú‚îÄ‚îÄ delivery.controller.ts       # HTTP –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã)
‚îú‚îÄ‚îÄ delivery.service.ts          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îî‚îÄ‚îÄ delivery.module.ts           # –ú–æ–¥—É–ª—å NestJS
```

---

## üîç –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ

### 1Ô∏è‚É£ **CreateDeliveryDto** (—Ñ–∞–π–ª: `create-delivery.dto.ts`)

**–ß—Ç–æ —ç—Ç–æ?**
- DTO = Data Transfer Object (–æ–±—ä–µ–∫—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö)
- –û–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏

**–ó–∞—á–µ–º?**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–∫–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–∏—à–Ω–∏–µ –ø–æ–ª—è)

**–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
```json
{
  "title": "–î–æ–∫—É–º–µ–Ω—Ç—ã",
  "fromAddress": "—É–ª. –õ–µ–Ω–∏–Ω–∞ 10, –ú–∏–Ω—Å–∫",
  "toAddress": "–ø—Ä. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π 5, –ì—Ä–æ–¥–Ω–æ",
  "price": 100,
  "size": "small",
  "weight": 0.5,
  "description": "–°—Ä–æ—á–Ω–æ!",
  "notes": "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 10 –º–∏–Ω—É—Ç"
}
```

**–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
- `@IsString()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ–ª–µ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
- `@IsNotEmpty()` - –ø–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
- `@IsNumber()` - –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º
- `@Min(0)` - —á–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 0
- `@IsOptional()` - –ø–æ–ª–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ
- `@IsEnum([...])` - –ø–æ–ª–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π

---

### 2Ô∏è‚É£ **DeliveryDto** (—Ñ–∞–π–ª: `delivery.dto.ts`)

**–ß—Ç–æ —ç—Ç–æ?**
- –û–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

**–û—Ç–ª–∏—á–∏–µ –æ—Ç CreateDeliveryDto:**
- CreateDeliveryDto - —á—Ç–æ **–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** –∫–ª–∏–µ–Ω—Ç (input)
- DeliveryDto - —á—Ç–æ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç** —Å–µ—Ä–≤–µ—Ä (output)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ DeliveryDto:**
```typescript
id: number           // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
senderId: string     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ç–æ–∫–µ–Ω–∞
status: 'pending'    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è 'pending'
createdAt: Date      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
updatedAt: Date      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
```

---

### 3Ô∏è‚É£ **DeliveryService** (—Ñ–∞–π–ª: `delivery.service.ts`)

**–ú–µ—Ç–æ–¥ `createDeliveryRequest`**

```typescript
async createDeliveryRequest(
  senderId: string,              // UID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏–∑ Firebase
  createDto: CreateDeliveryDto,  // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ
): Promise<DeliveryDto>
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ (–ø–æ—Å—Ç—Ä–æ—á–Ω–æ):**

1. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:**
```typescript
const newRequest: DeliveryDto = {
  id: this.deliveryRequests.length + 1,  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
  senderId,                               // UID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  pickerId: createDto.pickerId || null,   // UID –∫—É—Ä—å–µ—Ä–∞ –∏–ª–∏ null
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ DTO
  status: 'pending',                      // –°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  createdAt: new Date(),                  // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞
  updatedAt: new Date(),
};
```

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤ (–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ë–î):**
```typescript
this.deliveryRequests.push(newRequest);
```

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—é (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω):**
```typescript
if (createDto.recipientId) {
  await this.notificationService.notifyIncomingDelivery(
    createDto.recipientId,
    newRequest.id,
    sender.name,
  );
}
```

4. **–í–æ–∑–≤—Ä–∞—Ç —Å–æ–∑–¥–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏:**
```typescript
return newRequest;
```

---

### 4Ô∏è‚É£ **DeliveryController** (—Ñ–∞–π–ª: `delivery.controller.ts`)

**Endpoint: POST /delivery/requests**

```typescript
@Post('requests')
@UseGuards(FirebaseAuthGuard)  // –ó–∞—â–∏—Ç–∞: —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
async createDeliveryRequest(
  @Req() req: ReqWithUser,           // –û–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
  @Body() createDto: CreateDeliveryDto,  // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
) {
  const { uid } = req.user;  // –î–æ—Å—Ç–∞—ë–º UID –∏–∑ —Ç–æ–∫–µ–Ω–∞
  return await this.deliveryService.createDeliveryRequest(uid, createDto);
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/delivery/requests`
2. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Firebase —Ç–æ–∫–µ–Ω (`@UseGuards(FirebaseAuthGuard)`)
3. –ò–∑ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç–∞—ë—Ç—Å—è UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`req.user.uid`)
4. –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ `CreateDeliveryDto`
5. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–µ—Ä–≤–∏—Å —Å UID –∏ DTO
6. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É

---

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ª–Ω—ã–π flow)

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
```http
POST /delivery/requests
Authorization: Bearer <firebase-token>
Content-Type: application/json

{
  "title": "–î–æ–∫—É–º–µ–Ω—Ç—ã",
  "fromAddress": "—É–ª. –õ–µ–Ω–∏–Ω–∞ 10, –ú–∏–Ω—Å–∫",
  "toAddress": "–ø—Ä. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π 5, –ì—Ä–æ–¥–Ω–æ",
  "price": 100,
  "size": "small"
}
```

### –®–∞–≥ 2: Controller –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Firebase —Ç–æ–∫–µ–Ω
- –î–æ—Å—Ç–∞—ë—Ç UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç JSON –≤ CreateDeliveryDto

### –®–∞–≥ 3: Service –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç DeliveryDto
- –î–æ–±–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (id, status, dates)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –º–∞—Å—Å–∏–≤ (–∏–ª–∏ –ë–î)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –®–∞–≥ 4: –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
```json
{
  "id": 4,
  "senderId": "firebase-uid-123",
  "pickerId": null,
  "title": "–î–æ–∫—É–º–µ–Ω—Ç—ã",
  "fromAddress": "—É–ª. –õ–µ–Ω–∏–Ω–∞ 10, –ú–∏–Ω—Å–∫",
  "toAddress": "–ø—Ä. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π 5, –ì—Ä–æ–¥–Ω–æ",
  "price": 100,
  "size": "small",
  "status": "pending",
  "createdAt": "2025-01-17T10:30:00.000Z",
  "updatedAt": "2025-01-17T10:30:00.000Z"
}
```

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
- **Controller** - —Ç–æ–ª—å–∫–æ –ø—Ä–∏—ë–º/–æ—Ç–ø—Ä–∞–≤–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- **Service** - –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- **DTO** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### 2. **–¢–∏–ø–∏–∑–∞—Ü–∏—è**
TypeScript –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø—ã –Ω–∞ —ç—Ç–∞–ø–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
createDto.price = 100;

// ‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
createDto.price = "—Å—Ç–æ";  // Error: Type 'string' is not assignable to type 'number'
```

### 3. **–í–∞–ª–∏–¥–∞—Ü–∏—è**
–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `class-validator` –ø—Ä–æ–≤–µ—Ä—è—é—Ç –¥–∞–Ω–Ω—ã–µ:
```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
{ price: 100 }

// ‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (—Ü–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π)
{ price: -50 }  // Error: price must not be less than 0
```

### 4. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**
–ú–Ω–æ–≥–∏–µ –≤–µ—â–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- UID –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ç–æ–∫–µ–Ω–∞ (–Ω–µ –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞)
- ID –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
- –î–∞—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°—Ç–∞—Ç—É—Å —Å—Ç–∞–≤–∏—Ç—Å—è 'pending' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

---

## üìù –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ PostgreSQL, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç:

1. **–ó–∞–º–µ–Ω–∏—Ç—å –º–∞—Å—Å–∏–≤ –Ω–∞ Repository:**
```typescript
// –ë—ã–ª–æ
private deliveryRequests: DeliveryDto[] = [...MOCK_DELIVERY_REQUESTS];

// –°—Ç–∞–Ω–µ—Ç
constructor(
  @InjectRepository(Delivery)
  private deliveryRepository: Repository<Delivery>,
) {}
```

2. **–ó–∞–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```typescript
// –ë—ã–ª–æ
this.deliveryRequests.push(newRequest);

// –°—Ç–∞–Ω–µ—Ç
await this.deliveryRepository.save(newRequest);
```

3. **–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∏ —Å User:**
```typescript
const sender = await this.userRepository.findOne({ where: { uid: senderId } });
```

–ù–æ –ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ–º —Å –º–æ–∫–∞–º–∏, –∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏! üéâ
